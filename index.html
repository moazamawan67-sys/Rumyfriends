<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฑู ุณฺฉูุฑ ูนุฑฺฉุฑ (ููุงู ููฺ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ุชูุงู ุณูนุงุฆูุฒ ุงููพุฑ ูุงู ูุงุฆู ฺฉ ุทุฑุญ  ุฑฺบ ฺฏ */
        body { font-family: 'Noto Nastaliq Urdu', serif; background-color: #f8fafc; }
        .urdu-font-bold { font-weight: 700; }
        .urdu-font-normal { font-weight: 400; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 300px; max-height: 40vh; }
        @media (min-width: 640px) { .chart-container { height: 350px; } }
        .warning-blink { animation: border-blink 1.5s infinite ease-in-out; box-shadow: 0 0 16px rgba(234, 179, 8, 0.6); }
        @keyframes border-blink { 0% { border-color: #f59e0b; } 50% { border-color: #fef3c7; } 100% { border-color: #f59e0b; } }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #06b6d4; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .score-input { text-align: center !important; }
        .delete-btn { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); opacity: 0; transition: opacity 0.2s; }
        .history-item:hover .delete-btn { opacity: 1; }
        .record-details-modal { max-height: 80vh; overflow-y: auto; }
        .round-detail-item { transition: background-color 0.2s; }
        .round-detail-item:hover { background-color: #f8fafc; }
        .lucky-badge { background-color: #fef3c7; color: #d97706; border: 1px solid #f59e0b; }
        .normal-badge { background-color: #dbeafe; color: #1d4ed8; border: 1px solid #3b82f6; }
        .grid-cols-player-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        .grid-cols-player-5 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        .grid-cols-player-6 { grid-template-columns: repeat(6, minmax(0, 1fr)); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2rem; font-weight: bold; margin: 0.5rem 0; }
        .stat-label { font-size: 0.9rem; opacity: 0.9; }
        .player-stats { background: #f8fafc; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #06b6d4; }
        .progress-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin: 0.5rem 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #06b6d4, #3b82f6); transition: width 0.3s ease; }
        .view-only-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .view-only-modal { background: white; padding: 2rem; border-radius: 16px; text-align: center; max-width: 500px; margin: 1rem; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .new-game-options { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem; }
        .new-game-btn { padding: 1rem; border: 2px solid #06b6d4; border-radius: 12px; background: white; color: #06b6d4; cursor: pointer; transition: all 0.3s ease; }
        .new-game-btn:hover { background: #06b6d4; color: white; }
        .game-lock-banner { background: linear-gradient(135deg, #ff6b6b, #ee5a52); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; text-align: center; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .delete-record-btn { position: absolute; left: 1rem; top: 1rem; background: #ef4444; color: white; border: none; border-radius: 8px; padding: 0.5rem 1rem; cursor: pointer; opacity: 0; transition: opacity 0.3s ease; font-size: 0.875rem; }
        .record-item:hover .delete-record-btn { opacity: 1; }
        .delete-record-btn:hover { background: #dc2626; }
        .record-item { position: relative; }
        .login-modal { background: white; padding: 2rem; border-radius: 16px; text-align: center; max-width: 400px; margin: 1rem; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .login-tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 2px solid #e2e8f0; }
        .login-tab { flex: 1; padding: 0.75rem; background: none; border: none; cursor: pointer; font-family: 'Noto Nastaliq Urdu', serif; font-weight: 700; transition: all 0.3s ease; }
        .login-tab.active { color: #06b6d4; border-bottom: 3px solid #06b6d4; }
        .user-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; margin-left: 1rem; }
        .admin-badge { background: #06b6d4; color: white; }
        .user-badge-style { background: #10b981; color: white; }
        .moazam-name { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700; font-size: 1.8rem; margin: 10px 0; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .welcome-message { font-size: 1.2rem; color: #4b5563; margin-bottom: 20px; }
        #settings-modal .bg-white { max-height: 85vh; overflow-y: auto; }
        #player-name-inputs, #new-player-name-inputs { max-height: 300px; overflow-y: auto; padding-right: 8px; }
        #player-name-inputs::-webkit-scrollbar, #new-player-name-inputs::-webkit-scrollbar { width: 6px; }
        #player-name-inputs::-webkit-scrollbar-track, #new-player-name-inputs::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #player-name-inputs::-webkit-scrollbar-thumb, #new-player-name-inputs::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        #player-name-inputs::-webkit-scrollbar-thumb:hover, #new-player-name-inputs::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        #settings-modal .bg-white > .mt-8 { position: sticky; bottom: 0; background: white; padding-top: 16px; border-top: 1px solid #e2e8f0; margin-top: 16px; }
        
        /* Backup/Export Styles */
        .backup-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-weight: bold; }
        .backup-btn:hover { opacity: 0.9; }
        .import-section { margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 10px; border: 2px dashed #06b6d4; }
        .data-export { background: #d1fae5; padding: 10px; border-radius: 8px; margin-top: 10px; word-break: break-all; font-size: 12px; }
    </style>
</head>
<body class="text-slate-800">
    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="login-modal">
            <div class="text-4xl mb-4">๐ฎ</div>
            <h2 class="text-2xl urdu-font-bold mb-2 text-slate-800">ุฑู ุณฺฉูุฑ ูนุฑฺฉุฑ</h2>
            <div class="moazam-name urdu-font-bold">Moazam Awan</div>
            <p class="welcome-message urdu-font-normal">ููุงู ููฺ - ุงููนุฑููน ฺฉ ุถุฑูุฑุช ูฺบ</p>
            
            <div class="login-tabs">
                <button id="user-tab" class="login-tab active urdu-font-bold">ูุฒุฑ</button>
                <button id="admin-tab" class="login-tab urdu-font-bold">ุงฺูู</button>
            </div>
            
            <div id="user-login-form" class="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="user-password" class="block text-sm urdu-font-normal text-slate-600 mb-1 text-right">ูุฒุฑ ูพุงุณูุฑฺ</label>
                        <input type="password" id="user-password" class="w-full p-3 border border-slate-300 rounded-lg text-center urdu-font-normal" placeholder="ูพุงุณูุฑฺ ุฏุฑุฌ ฺฉุฑฺบ" value="user123">
                    </div>
                    <button id="user-login-btn" class="w-full bg-green-600 text-white urdu-font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200">
                        ูุฒุฑ ููฺฏ ุงู
                    </button>
                </div>
            </div>
            
            <div id="admin-login-form" class="login-form hidden">
                <div class="space-y-4">
                    <div>
                        <label for="admin-password" class="block text-sm urdu-font-normal text-slate-600 mb-1 text-right">ุงฺูู ูพุงุณูุฑฺ</label>
                        <input type="password" id="admin-password" class="w-full p-3 border border-slate-300 rounded-lg text-center urdu-font-normal" placeholder="ูพุงุณูุฑฺ ุฏุฑุฌ ฺฉุฑฺบ" value="admin123">
                    </div>
                    <button id="admin-login-btn" class="w-full bg-cyan-600 text-white urdu-font-bold py-3 px-4 rounded-lg hover:bg-cyan-700 transition-colors duration-200">
                        ุงฺูู ููฺฏ ุงู
                    </button>
                </div>
            </div>
            
            <div class="mt-6">
                <button id="skip-login-btn" class="w-full bg-gray-200 text-gray-800 urdu-font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors duration-200">
                    ๐ง ููุฑ ุดุฑูุน ฺฉุฑฺบ (ุจุบุฑ ูพุงุณูุฑฺ)
                </button>
            </div>
            
            <div class="mt-4 text-center">
                <p class="text-xs text-slate-500 urdu-font-normal">
                    ูุฒุฑ: ุณฺฉูุฑ ุฏุฑุฌ ฺฉุฑ ุณฺฉุชุง  โข ุงฺูู: ูฺฉูู ฺฉููนุฑูู
                </p>
                <p class="text-xs text-green-600 urdu-font-normal mt-2">
                    โ ููุงู ููฺ - ุงููนุฑููน ฺฉ ุถุฑูุฑุช ูฺบ
                </p>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <!-- Loading Indicator (ูุฎุชุตุฑ) -->
        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 transition-opacity duration-500">
            <div class="flex flex-col items-center">
                <div class="loader"></div>
                <p id="loading-text" class="mt-3 urdu-font-bold text-slate-700">ููุงู ฺูนุง ููฺ ู ุฑุง ...</p>
            </div>
        </div>

        <header class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
            <div>
                <div class="flex items-center gap-3">
                    <div>
                        <h1 class="text-3xl md:text-4xl urdu-font-bold text-slate-900">ุฑู ุณฺฉูุฑ ูนุฑฺฉุฑ ๐ฑ</h1>
                        <div class="moazam-name urdu-font-bold text-xl">Moazam Awan</div>
                    </div>
                    <span id="user-role-badge" class="user-badge urdu-font-normal"></span>
                    <button id="logout-btn" class="text-sm urdu-font-normal text-slate-500 hover:text-slate-700 transition-colors">
                        (ููฺฏ ุขุคูน)
                    </button>
                </div>
                <div class="flex items-center gap-2 mt-1">
                    <span id="sync-status" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded urdu-font-normal">โ ููุงู ููฺ</span>
                    <span id="device-id" class="text-xs text-slate-400">ฺูุงุฆุณ: <span id="device-id-display" class="text-cyan-600">...</span></span>
                </div>
                <p id="game-status" class="text-slate-500 urdu-font-normal mt-1">ฺฉฺพู ุฌุงุฑ ุ ุญุฏ <span id="limit-display-header" class="urdu-font-bold">800</span> </p>
            </div>
            <div class="flex items-center gap-2">
                <button id="backup-btn" class="p-3 rounded-full hover:bg-slate-200 transition-colors duration-200" title="ฺูนุง ุจฺฉ ุงูพ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                </button>
                <button id="stats-btn" class="p-3 rounded-full hover:bg-slate-200 transition-colors duration-200" aria-label="ุดูุงุฑุงุช">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                </button>
                <button id="settings-btn" aria-label="ุชุฑุชุจุงุช" class="p-3 rounded-full hover:bg-slate-200 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h-.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
                <!-- ูพุงุณูุฑฺ ุจูนู ุตุฑู ุงฺูู ฺฉ ู -->
                <button id="password-btn" class="p-3 rounded-full hover:bg-slate-200 transition-colors duration-200 hidden" aria-label="ูพุงุณูุฑฺ ุชุจุฏู ฺฉุฑฺบ">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                    </svg>
                </button>
            </div>
        </header>

        <main>
            <!-- Scoreboard Section -->
            <section id="scoreboard-section" class="mb-8">
                <h2 class="text-2xl urdu-font-bold mb-4">ููุฌูุฏ ุณฺฉูุฑ ุจูุฑฺ</h2>
                 <div id="game-over-message" class="hidden p-4 mb-4 text-center bg-red-100 border-r-4 border-red-500 text-red-700 rounded-lg">
                    <p class="urdu-font-bold text-xl mb-3"></p>
                    <div class="flex flex-col sm:flex-row justify-center gap-3">
                         <button id="record-game-btn" class="hidden px-4 py-2 bg-purple-600 text-white urdu-font-normal rounded-lg hover:bg-purple-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <span id="record-text">ฺฏู ูุญููุธ ฺฉุฑฺบ</span>
                            <div id="record-spinner" class="loader hidden w-4 h-4"></div>
                        </button>
                        <button id="reset-game-btn" class="hidden px-4 py-2 bg-cyan-600 text-white urdu-font-normal rounded-lg hover:bg-cyan-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                             ูุง ฺฏู ุดุฑูุน ฺฉุฑฺบ 
                        </button>
                    </div>
                </div>
                <div id="scoreboard" class="grid grid-cols-2 gap-4"> 
                     <p class="col-span-2 md:col-span-4 text-center text-slate-400 urdu-font-normal" id="scoreboard-loading">ุณฺฉูุฑ ุจูุฑฺ ููฺ ู ุฑุง ...</p>
                </div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-2">
                     <section id="input-section" class="bg-white p-6 rounded-2xl shadow-md border border-slate-200 h-full">
                        <h2 class="text-2xl urdu-font-bold mb-4">ูุง ุฑุงุคูฺ ุฏุฑุฌ ฺฉุฑฺบ</h2>
                        <div id="round-type-indicator" class="mb-4 p-3 rounded-lg text-center urdu-font-bold text-lg"></div>
                        <div class="space-y-4">
                            <div id="player-inputs"></div>
                             <p id="score-error" class="text-red-600 text-sm hidden urdu-font-normal">ุบูุท: ุงฺฉ ฺฉฺพูุงฺ ฺฉุง ุณฺฉูุฑ 0 ููุง ฺุงุฆุ ุงูุฑ ุจุงููฺบ ฺฉุง 0 ุณ ุฒุงุฏ</p>
                            <button id="save-score-btn" disabled class="w-full bg-cyan-600 text-white urdu-font-bold py-3 px-4 rounded-lg hover:bg-cyan-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors duration-200 flex items-center justify-center gap-2">
                                <span id="save-text">ุณฺฉูุฑ ูุญููุธ ฺฉุฑฺบ</span>
                                <div id="save-spinner" class="loader hidden w-4 h-4"></div>
                            </button>
                        </div>
                    </section>
                </div>
                <div class="lg:col-span-3">
                     <section id="chart-section" class="bg-white p-6 rounded-2xl shadow-md border border-slate-200">
                        <h2 class="text-2xl urdu-font-bold mb-4">ุณฺฉูุฑ ฺฉุง ฺฏุฑุงู</h2>
                        <p class="text-sm text-slate-500 urdu-font-normal mb-3"> ฺฏุฑุงู ุฑ ฺฉฺพูุงฺ ฺฉ ฺฉู ุณฺฉูุฑ ฺฉู ุฑ ุฑุงุคูฺ ฺฉ ุจุนุฏ ุธุงุฑ ฺฉุฑุชุง </p>
                        <div class="chart-container">
                            <canvas id="score-chart"></canvas>
                        </div>
                    </section>
                </div>
            </div>

            <!-- History Section -->
            <section id="history-section" class="mt-8">
                <h2 class="text-2xl urdu-font-bold mb-4">ุฑุงุคูฺ ฺฉ ุชุงุฑุฎ</h2>
                <div class="bg-white rounded-2xl shadow-md border border-slate-200">
                    <div id="history-list" class="divide-y divide-slate-200">
                        <p id="no-history-msg" class="p-6 text-center text-slate-500 urdu-font-normal">ุงุจฺพ ุชฺฉ ฺฉูุฆ ุฑุงุคูฺ ูฺบ ฺฉฺพูุง ฺฏุง</p>
                    </div>
                </div>
            </section>
            
            <!-- Records Section -->
            <section id="records-section" class="mt-8">
                <h2 class="text-2xl urdu-font-bold mb-4 flex justify-between items-center">
                    ูุญููุธ ุดุฏ ฺฏูุฒ
                    <button id="refresh-records-btn" class="text-sm urdu-font-normal text-cyan-600 hover:text-cyan-800 transition-colors flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"></path><path d="M2.5 22v-6h6"></path><path d="M2.5 16a10 10 0 0 1 18.5-4.5M21.5 8a10 10 0 0 1-18.5 4.5"></path></svg>
                         ุชุงุฒ ฺฉุฑฺบ
                    </button>
                </h2>
                <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-4">
                    <div id="records-list">
                        <p class="text-center text-slate-500 urdu-font-normal" id="records-loading-msg">ุฑฺฉุงุฑฺุฒ ููฺ ู ุฑ ฺบ...</p>
                    </div>
                </div>
            </section>
            
            <!-- Backup Section -->
            <section id="backup-section" class="mt-8">
                <h2 class="text-2xl urdu-font-bold mb-4">ฺูนุง ุจฺฉ ุงูพ</h2>
                <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg urdu-font-bold mb-3 text-slate-800">ฺูนุง ุงฺฉุณูพูุฑูน</h3>
                            <p class="text-sm text-slate-600 urdu-font-normal mb-3">ุงูพู ฺูนุง ฺฉู ูุญููุธ ฺฉุฑู ฺฉ ู ุงฺฉุณูพูุฑูน ฺฉุฑฺบ</p>
                            <button id="export-data-btn" class="backup-btn urdu-font-bold">
                                ๐ฅ ฺูนุง ุงฺฉุณูพูุฑูน ฺฉุฑฺบ
                            </button>
                            <div id="export-data-display" class="data-export hidden"></div>
                        </div>
                        <div>
                            <h3 class="text-lg urdu-font-bold mb-3 text-slate-800">ฺูนุง ุงููพูุฑูน</h3>
                            <p class="text-sm text-slate-600 urdu-font-normal mb-3">ูพู ุณ ูุญููุธ ฺูนุง ฺฉู ูุงูพุณ ููฺ ฺฉุฑฺบ</p>
                            <div class="import-section">
                                <textarea id="import-data-input" class="w-full p-3 border border-slate-300 rounded-lg text-sm" rows="4" placeholder="ุงฺบ ุงฺฉุณูพูุฑูน ุดุฏ ฺูนุง ูพุณูน ฺฉุฑฺบ..."></textarea>
                                <button id="import-data-btn" class="mt-3 w-full bg-green-600 text-white urdu-font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                                    ๐ค ฺูนุง ุงููพูุฑูน ฺฉุฑฺบ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex-shrink-0">
                <h2 class="text-2xl urdu-font-bold mb-6 text-center">ฺฏู ุชุฑุชุจุงุช</h2>
            </div>
            
            <div class="flex-1 overflow-y-auto pr-2 -mr-2">
                <div class="space-y-4">
                    <div>
                        <label for="game-limit-input" class="block text-sm urdu-font-normal text-slate-600 mb-1">ฺฏู ฺฉ ุญุฏ (ููุฒุฑ ุณฺฉูุฑ)</label>
                        <input type="number" id="game-limit-input" min="100" class="w-full p-2 border border-slate-300 rounded-lg text-center" value="800">
                    </div>

                    <!-- DYNAMIC PLAYER MANAGEMENT -->
                    <div id="player-name-inputs-container">
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm urdu-font-normal text-slate-600">ฺฉฺพูุงฺูฺบ ฺฉ ูุงู</label>
                            <div class="flex gap-2">
                                <button id="remove-player-btn" class="text-red-600 hover:bg-red-50 p-1 rounded-full disabled:opacity-50 transition-colors" title="ฺฉฺพูุงฺ ูนุงุฆฺบ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path></svg>
                                </button>
                                <button id="add-player-btn" class="text-cyan-600 hover:bg-cyan-50 p-1 rounded-full disabled:opacity-50 transition-colors" title="ฺฉฺพูุงฺ ุดุงูู ฺฉุฑฺบ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div id="player-name-inputs" class="space-y-3"></div>
                    </div>

                    <!-- NEW GAME OPTIONS -->
                    <div class="mt-6 pt-6 border-t border-slate-200">
                        <h3 class="text-lg urdu-font-bold mb-4 text-slate-800">ูุฆ ฺฏู ฺฉ ุงุฎุชุงุฑุงุช</h3>
                        
                        <div class="space-y-3 mb-4">
                            <div id="custom-player-names">
                                <label class="block text-sm urdu-font-normal text-slate-600 mb-2">ฺฉฺพูุงฺูฺบ ฺฉ ูุฆ ูุงู</label>
                                <div id="new-player-name-inputs"></div>
                            </div>
                        </div>
                        
                        <button id="create-new-game-btn" class="w-full bg-green-600 text-white urdu-font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200">
                            ๐ ูุฆ ฺฏู ุดุฑูุน ฺฉุฑฺบ
                        </button>
                        <p class="text-xs text-slate-500 urdu-font-normal mt-2 text-center">
                            ููุฌูุฏ ฺฏู ฺฉ ฺูนุง ฺฉู ูุญููุธ ฺฉุฑ ุฏุง ุฌุงุฆ ฺฏุง
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="flex-shrink-0 mt-6 pt-4 border-t border-slate-200">
                <div class="flex justify-end gap-4">
                    <button id="cancel-settings-btn" class="px-4 py-2 bg-slate-200 text-slate-800 urdu-font-normal rounded-lg hover:bg-slate-300 transition-colors">ููุณูุฎ</button>
                    <button id="save-settings-btn" class="px-4 py-2 bg-cyan-600 text-white urdu-font-bold rounded-lg hover:bg-cyan-700 transition-colors">ูุญููุธ ฺฉุฑฺบ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md">
            <h2 class="text-2xl urdu-font-bold mb-6 text-center">ูพุงุณูุฑฺ ููุฌูููน</h2>
            
            <div class="space-y-4">
                <div>
                    <label for="admin-password-change" class="block text-sm urdu-font-normal text-slate-600 mb-1">ูุง ุงฺูู ูพุงุณูุฑฺ</label>
                    <input type="password" id="admin-password-change" class="w-full p-2 border border-slate-300 rounded-lg text-center urdu-font-normal" placeholder="ูุง ุงฺูู ูพุงุณูุฑฺ">
                </div>
                <div>
                    <label for="user-password-change" class="block text-sm urdu-font-normal text-slate-600 mb-1">ูุง ูุฒุฑ ูพุงุณูุฑฺ</label>
                    <input type="password" id="user-password-change" class="w-full p-2 border border-slate-300 rounded-lg text-center urdu-font-normal" placeholder="ูุง ูุฒุฑ ูพุงุณูุฑฺ">
                </div>
                <button id="change-passwords-btn" class="w-full bg-blue-600 text-white urdu-font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">
                    ูพุงุณูุฑฺุฒ ุชุจุฏู ฺฉุฑฺบ
                </button>
            </div>
            
            <div class="mt-8 flex justify-end">
                <button id="cancel-password-btn" class="px-4 py-2 bg-slate-200 text-slate-800 urdu-font-normal rounded-lg hover:bg-slate-300 transition-colors">ููุณูุฎ</button>
            </div>
        </div>
    </div>

    <!-- Record Details Modal -->
    <div id="record-details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-4xl record-details-modal">
            <h2 class="text-2xl urdu-font-bold mb-6 text-center">ฺฏู ฺฉ ูฺฉูู ุชูุตู</h2>
            <div id="record-details-content"></div>
            <div class="mt-8 flex justify-end">
                <button id="close-record-details-btn" class="px-4 py-2 bg-slate-200 text-slate-800 urdu-font-normal rounded-lg hover:bg-slate-300 transition-colors">ุจูุฏ ฺฉุฑฺบ</button>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="stats-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl urdu-font-bold mb-6 text-center">ฺฏู ฺฉุง ุฎูุงุต ุงูุฑ ุดูุงุฑุงุช</h2>
            <div id="stats-content"></div>
            <div class="mt-8 flex justify-end gap-4">
                <button id="close-stats-btn" class="px-4 py-2 bg-slate-200 text-slate-800 urdu-font-normal rounded-lg hover:bg-slate-300 transition-colors">ุจูุฏ ฺฉุฑฺบ</button>
            </div>
        </div>
    </div>

    <!-- Backup Modal -->
    <div id="backup-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-2xl">
            <h2 class="text-2xl urdu-font-bold mb-6 text-center">ฺูนุง ููุฌูููน</h2>
            
            <div class="space-y-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="text-lg urdu-font-bold text-blue-800 mb-2">ุงฺฉุณูพูุฑูน ฺูนุง</h3>
                    <p class="text-sm text-blue-600 urdu-font-normal mb-3"> ฺฉูฺ ฺฉุงูพ ฺฉุฑฺบ ุงูุฑ ูุญููุธ ฺฉุฑ ูฺบ:</p>
                    <textarea id="export-textarea" class="w-full p-3 border border-blue-300 rounded-lg text-sm font-mono" rows="6" readonly></textarea>
                    <button id="copy-export-btn" class="mt-3 w-full bg-blue-600 text-white urdu-font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        ๐ ฺฉูฺ ฺฉุงูพ ฺฉุฑฺบ
                    </button>
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h3 class="text-lg urdu-font-bold text-green-800 mb-2">ุงููพูุฑูน ฺูนุง</h3>
                    <p class="text-sm text-green-600 urdu-font-normal mb-3">ูพู ุณ ูุญููุธ ฺฉูฺ ุงฺบ ูพุณูน ฺฉุฑฺบ:</p>
                    <textarea id="import-textarea" class="w-full p-3 border border-green-300 rounded-lg text-sm" rows="4" placeholder="ุงฺบ ุงฺฉุณูพูุฑูน ุดุฏ ฺฉูฺ ูพุณูน ฺฉุฑฺบ..."></textarea>
                    <button id="import-backup-btn" class="mt-3 w-full bg-green-600 text-white urdu-font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        ๐ค ฺูนุง ููฺ ฺฉุฑฺบ
                    </button>
                </div>
                
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h3 class="text-lg urdu-font-bold text-red-800 mb-2">ฺูนุง ฺฉูุฆุฑ</h3>
                    <p class="text-sm text-red-600 urdu-font-normal mb-3">ุชูุงู ฺูนุง ุตุงู ฺฉุฑู ฺฉ ู:</p>
                    <button id="clear-all-data-btn" class="w-full bg-red-600 text-white urdu-font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">
                        ๐๏ธ ุชูุงู ฺูนุง ุตุงู ฺฉุฑฺบ
                    </button>
                </div>
            </div>
            
            <div class="mt-8 flex justify-end">
                <button id="close-backup-btn" class="px-4 py-2 bg-slate-200 text-slate-800 urdu-font-normal rounded-lg hover:bg-slate-300 transition-colors">ุจูุฏ ฺฉุฑฺบ</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== LOCAL STORAGE SYSTEM ====================
        const DEFAULT_PASSWORDS = {
            admin: 'admin123',
            user: 'user123'
        };

        let currentUser = null;
        let passwords = { ...DEFAULT_PASSWORDS };

        // ==================== DEFAULT STATE ====================
        const DEFAULT_GAME_STATE = {
            players: [
                { id: 'p1', name: 'ูุนุธู', score: 0 },
                { id: 'p2', name: 'ุงูุณุงู', score: 0 },
                { id: 'p3', name: 'ููุงุฑ', score: 0 },
                { id: 'p4', name: 'ุฒุงุฏ', score: 0 },
            ],
            gameLimit: 800,
            warningThreshold: 100,
            history: [],
            isGameOver: false,
            isRecorded: false,
            lastUpdated: new Date().toISOString(),
            deviceId: null
        };

        let gameState = {...DEFAULT_GAME_STATE};
        let userId = null;
        let isViewOnlyMode = false;

        // ==================== UI ELEMENTS ====================
        const ui = {
            // Login UI
            loginModal: document.getElementById('login-modal'),
            userTab: document.getElementById('user-tab'),
            adminTab: document.getElementById('admin-tab'),
            userLoginForm: document.getElementById('user-login-form'),
            adminLoginForm: document.getElementById('admin-login-form'),
            userPassword: document.getElementById('user-password'),
            adminPassword: document.getElementById('admin-password'),
            userLoginBtn: document.getElementById('user-login-btn'),
            adminLoginBtn: document.getElementById('admin-login-btn'),
            skipLoginBtn: document.getElementById('skip-login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            userRoleBadge: document.getElementById('user-role-badge'),
            
            // Main App UI
            app: document.getElementById('app'),
            loadingOverlay: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text'),
            deviceIdDisplay: document.getElementById('device-id-display'),
            gameStatus: document.getElementById('game-status'),
            limitDisplayHeader: document.getElementById('limit-display-header'),
            scoreboard: document.getElementById('scoreboard'),
            scoreboardLoading: document.getElementById('scoreboard-loading'),
            gameOverMessage: document.getElementById('game-over-message'),
            resetGameBtn: document.getElementById('reset-game-btn'),
            recordGameBtn: document.getElementById('record-game-btn'),
            recordText: document.getElementById('record-text'),
            recordSpinner: document.getElementById('record-spinner'),
            playerInputs: document.getElementById('player-inputs'),
            scoreError: document.getElementById('score-error'),
            saveScoreBtn: document.getElementById('save-score-btn'),
            saveText: document.getElementById('save-text'),
            saveSpinner: document.getElementById('save-spinner'),
            historyList: document.getElementById('history-list'),
            noHistoryMsg: document.getElementById('no-history-msg'),
            settingsBtn: document.getElementById('settings-btn'),
            passwordBtn: document.getElementById('password-btn'),
            settingsModal: document.getElementById('settings-modal'),
            passwordModal: document.getElementById('password-modal'),
            gameLimitInput: document.getElementById('game-limit-input'),
            playerNameInputs: document.getElementById('player-name-inputs'),
            cancelSettingsBtn: document.getElementById('cancel-settings-btn'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            cancelPasswordBtn: document.getElementById('cancel-password-btn'),
            chartCanvas: document.getElementById('score-chart'),
            recordsList: document.getElementById('records-list'),
            refreshRecordsBtn: document.getElementById('refresh-records-btn'),
            recordDetailsModal: document.getElementById('record-details-modal'),
            recordDetailsContent: document.getElementById('record-details-content'),
            closeRecordDetailsBtn: document.getElementById('close-record-details-btn'),
            roundTypeIndicator: document.getElementById('round-type-indicator'),
            
            // Password Management
            adminPasswordChange: document.getElementById('admin-password-change'),
            userPasswordChange: document.getElementById('user-password-change'),
            changePasswordsBtn: document.getElementById('change-passwords-btn'),
            
            // Player Management
            addPlayerBtn: document.getElementById('add-player-btn'), 
            removePlayerBtn: document.getElementById('remove-player-btn'), 
            playerNameInputsContainer: document.getElementById('player-name-inputs-container'),
            
            // Statistics
            statsBtn: document.getElementById('stats-btn'),
            statsModal: document.getElementById('stats-modal'),
            statsContent: document.getElementById('stats-content'),
            closeStatsBtn: document.getElementById('close-stats-btn'),
            
            // New Game
            createNewGameBtn: document.getElementById('create-new-game-btn'),
            newPlayerNameInputs: document.getElementById('new-player-name-inputs'),
            
            // Backup/Export
            backupBtn: document.getElementById('backup-btn'),
            exportDataBtn: document.getElementById('export-data-btn'),
            exportDataDisplay: document.getElementById('export-data-display'),
            importDataInput: document.getElementById('import-data-input'),
            importDataBtn: document.getElementById('import-data-btn'),
            backupModal: document.getElementById('backup-modal'),
            exportTextarea: document.getElementById('export-textarea'),
            importTextarea: document.getElementById('import-textarea'),
            copyExportBtn: document.getElementById('copy-export-btn'),
            importBackupBtn: document.getElementById('import-backup-btn'),
            clearAllDataBtn: document.getElementById('clear-all-data-btn'),
            closeBackupBtn: document.getElementById('close-backup-btn')
        };

        let scoreChart;
        let isSaving = false;

        // ==================== LOGIN SYSTEM ====================
        const initializeLoginSystem = () => {
            // Load saved passwords
            const savedPasswords = localStorage.getItem('rummy_passwords');
            if (savedPasswords) {
                passwords = JSON.parse(savedPasswords);
            }

            // Login tab switching
            ui.userTab.addEventListener('click', () => {
                ui.userTab.classList.add('active');
                ui.adminTab.classList.remove('active');
                ui.userLoginForm.classList.remove('hidden');
                ui.adminLoginForm.classList.add('hidden');
            });

            ui.adminTab.addEventListener('click', () => {
                ui.adminTab.classList.add('active');
                ui.userTab.classList.remove('active');
                ui.adminLoginForm.classList.remove('hidden');
                ui.userLoginForm.classList.add('hidden');
            });

            // Login buttons
            ui.userLoginBtn.addEventListener('click', handleUserLogin);
            ui.adminLoginBtn.addEventListener('click', handleAdminLogin);
            ui.skipLoginBtn.addEventListener('click', handleSkipLogin);

            // Logout button
            ui.logoutBtn.addEventListener('click', handleLogout);

            // Enter key support for login
            ui.userPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleUserLogin();
            });

            ui.adminPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAdminLogin();
            });
        };

        const handleUserLogin = () => {
            const password = ui.userPassword.value.trim();
            if (password === passwords.user) {
                currentUser = 'user';
                localStorage.setItem('rummy_current_user', 'user');
                localStorage.setItem('rummy_auto_login', 'true');
                showMainApp();
            } else {
                alert('ุบูุท ูพุงุณูุฑฺ! ฺูุงููน ูพุงุณูุฑฺ: user123');
                ui.userPassword.value = '';
                ui.userPassword.focus();
            }
        };

        const handleAdminLogin = () => {
            const password = ui.adminPassword.value.trim();
            if (password === passwords.admin) {
                currentUser = 'admin';
                localStorage.setItem('rummy_current_user', 'admin');
                localStorage.setItem('rummy_auto_login', 'true');
                showMainApp();
            } else {
                alert('ุบูุท ูพุงุณูุฑฺ! ฺูุงููน ูพุงุณูุฑฺ: admin123');
                ui.adminPassword.value = '';
                ui.adminPassword.focus();
            }
        };

        const handleSkipLogin = () => {
            // Auto login as user
            currentUser = 'user';
            localStorage.setItem('rummy_current_user', 'user');
            localStorage.setItem('rummy_auto_login', 'true');
            showMainApp();
            setStatus('ูุฒุฑ ููฺ ูฺบ ููุฑ ุดุฑูุน ู ฺฏุง');
        };

        const handleLogout = () => {
            if (confirm('ฺฉุง ุขูพ ูุงูุน ููฺฏ ุขุคูน ฺฉุฑูุง ฺุงุช ฺบุ')) {
                currentUser = null;
                localStorage.removeItem('rummy_current_user');
                localStorage.removeItem('rummy_auto_login');
                hideMainApp();
                ui.userPassword.value = '';
                ui.adminPassword.value = '';
                ui.userTab.click();
                alert('ุขูพ ฺฉุงูุงุจ ุณ ููฺฏ ุขุคูน ู ฺฏุฆ ฺบ');
            }
        };

        const showMainApp = () => {
            ui.loginModal.classList.add('hidden');
            ui.app.classList.remove('hidden');
            updateUIForUserRole();
            initializeApp();
        };

        const hideMainApp = () => {
            ui.app.classList.add('hidden');
            ui.loginModal.classList.remove('hidden');
        };

        const updateUIForUserRole = () => {
            if (currentUser === 'admin') {
                ui.userRoleBadge.textContent = 'ุงฺูู';
                ui.userRoleBadge.className = 'user-badge admin-badge urdu-font-normal';
                ui.passwordBtn.classList.remove('hidden');
            } else {
                ui.userRoleBadge.textContent = 'ูุฒุฑ';
                ui.userRoleBadge.className = 'user-badge user-badge-style urdu-font-normal';
                ui.passwordBtn.classList.add('hidden');
            }
        };

        const changePasswords = () => {
            const newAdminPassword = ui.adminPasswordChange.value.trim();
            const newUserPassword = ui.userPasswordChange.value.trim();

            if (newAdminPassword && newAdminPassword.length >= 4) {
                passwords.admin = newAdminPassword;
            }

            if (newUserPassword && newUserPassword.length >= 4) {
                passwords.user = newUserPassword;
            }

            localStorage.setItem('rummy_passwords', JSON.stringify(passwords));

            ui.adminPasswordChange.value = '';
            ui.userPasswordChange.value = '';

            setStatus('ูพุงุณูุฑฺุฒ ฺฉุงูุงุจ ุณ ุชุจุฏู ู ฺฏุฆ!');
            ui.passwordModal.classList.add('hidden');
        };

        // ==================== UTILITY FUNCTIONS ====================
        const formatScore = (score) => score.toLocaleString('ur-PK');

        const getRoundType = (roundNumber) => {
            const cyclePosition = (roundNumber - 1) % 5;
            return cyclePosition < 2 ? 'lucky' : 'normal';
        };

        const getRoundTypeDisplay = (roundType) => {
            return roundType === 'lucky' ? 'ูฺฉ ฺฏู' : 'ุณุงุฏ ฺฏู';
        };

        const getRoundMultiplier = (roundType) => {
            return roundType === 'lucky' ? 2 : 1;
        };

        const setStatus = (message, isError = false) => {
            const statusBox = document.createElement('div');
            statusBox.className = `p-3 mb-4 text-center rounded-lg urdu-font-normal ${isError ? 'bg-red-100 text-red-700' : 'bg-cyan-100 text-cyan-700'}`;
            statusBox.textContent = message;
            document.querySelector('main').prepend(statusBox);
            setTimeout(() => statusBox.remove(), 5000);
        };

        const getPlayerGridClass = (playerCount) => {
            if (playerCount === 2) return 'grid-cols-2';
            if (playerCount === 3) return 'grid-cols-3';
            if (playerCount === 5) return 'grid-cols-5';
            if (playerCount === 6) return 'grid-cols-6';
            return 'grid-cols-2 md:grid-cols-4'; 
        };

        // ==================== DATA MANAGEMENT ====================
        const saveGameState = () => {
            try {
                gameState.lastUpdated = new Date().toISOString();
                localStorage.setItem('rummy_current_game', JSON.stringify(gameState));
                console.log('โ Saved to localStorage');
                return true;
            } catch (error) {
                console.error('โ localStorage save failed:', error);
                setStatus('ฺูนุง ูุญููุธ ฺฉุฑู ูฺบ ูุงฺฉุงู', true);
                return false;
            }
        };

        const loadGameState = () => {
            try {
                const saved = localStorage.getItem('rummy_current_game');
                if (saved) {
                    const data = JSON.parse(saved);
                    gameState = {
                        ...DEFAULT_GAME_STATE,
                        ...data,
                        history: data.history || [],
                        players: data.players || DEFAULT_GAME_STATE.players
                    };
                    gameState.players = gameState.players.map((p, i) => ({
                        ...p,
                        id: 'p' + (i + 1)
                    }));
                    
                    // Generate device ID if not exists
                    if (!gameState.deviceId) {
                        gameState.deviceId = 'device_' + Date.now();
                        saveGameState();
                    }
                    
                    ui.deviceIdDisplay.textContent = gameState.deviceId.substring(0, 10);
                    console.log('โ Loaded from localStorage');
                }
                return true;
            } catch (error) {
                console.error('โ Load failed:', error);
                return false;
            }
        };

        // ==================== EVENT LISTENERS ====================
        const initializeEventListeners = () => {
            ui.resetGameBtn.addEventListener('click', handleResetGame);
            ui.saveScoreBtn.addEventListener('click', handleSaveScore);
            ui.recordGameBtn.addEventListener('click', handleRecordGame);
            ui.refreshRecordsBtn.addEventListener('click', () => fetchAndRenderRecords(true));
            ui.settingsBtn.addEventListener('click', () => {
                ui.settingsModal.classList.remove('hidden');
                renderSettingsModal();
            });
            ui.passwordBtn.addEventListener('click', () => {
                ui.passwordModal.classList.remove('hidden');
            });
            ui.cancelSettingsBtn.addEventListener('click', () => {
                ui.settingsModal.classList.add('hidden');
            });
            ui.cancelPasswordBtn.addEventListener('click', () => {
                ui.passwordModal.classList.add('hidden');
            });
            ui.saveSettingsBtn.addEventListener('click', handleSaveSettings);
            ui.closeRecordDetailsBtn.addEventListener('click', () => {
                ui.recordDetailsModal.classList.add('hidden');
            });
            
            // Password change
            ui.changePasswordsBtn.addEventListener('click', changePasswords);

            // Player Management
            ui.addPlayerBtn.addEventListener('click', handleAddPlayer);
            ui.removePlayerBtn.addEventListener('click', handleRemovePlayer);
            
            // New Game Creation
            ui.createNewGameBtn.addEventListener('click', handleCreateNewGameFromSettings);
            
            // Score input validation
            ui.playerInputs.addEventListener('input', (e) => {
                if (e.target.classList.contains('score-input')) {
                    validateScoreInputs();
                }
            });

            // Statistics
            ui.statsBtn.addEventListener('click', showGameStatistics);
            ui.closeStatsBtn.addEventListener('click', () => {
                ui.statsModal.classList.add('hidden');
            });
            
            // Backup/Export
            ui.backupBtn.addEventListener('click', showBackupModal);
            ui.exportDataBtn.addEventListener('click', exportData);
            ui.importDataBtn.addEventListener('click', importData);
            ui.copyExportBtn.addEventListener('click', copyExportData);
            ui.importBackupBtn.addEventListener('click', importBackupData);
            ui.clearAllDataBtn.addEventListener('click', clearAllData);
            ui.closeBackupBtn.addEventListener('click', () => {
                ui.backupModal.classList.add('hidden');
            });
        };

        // ==================== DYNAMIC PLAYER MANAGEMENT ====================
        const updatePlayerCountButtons = () => {
            ui.addPlayerBtn.disabled = gameState.players.length >= 6; 
            ui.removePlayerBtn.disabled = gameState.players.length <= 2; 
        };

        const handleAddPlayer = () => {
            if (gameState.players.length < 6) {
                const nextId = 'p' + (gameState.players.length + 1);
                gameState.players.push({
                    id: nextId,
                    name: `ฺฉฺพูุงฺ ${gameState.players.length + 1}`,
                    score: 0
                });
                renderSettingsModal();
                adjustModalHeight();
                setStatus('ุงฺฉ ูุง ฺฉฺพูุงฺ ุดุงูู ฺฉุฑ ุฏุง ฺฏุง');
            } else {
                setStatus('ุฒุงุฏ ุณ ุฒุงุฏ 6 ฺฉฺพูุงฺูฺบ ฺฉู ุดุงูู ฺฉุง ุฌุง ุณฺฉุชุง ', true);
            }
        };

        const handleRemovePlayer = () => {
            if (gameState.players.length > 2) {
                const removedPlayer = gameState.players.pop();
                
                if (gameState.history.length > 0) {
                     setStatus(`ุฎุจุฑุฏุงุฑ: ${removedPlayer.name} ฺฉู ูนุงู ุณ ููุฌูุฏ ุณฺฉูุฑ ุงูุฑ ุชุงุฑุฎ ูฺบ ุฎูู ูพฺ ุณฺฉุชุง  ูุง ฺฏู ุดุฑูุน ฺฉุฑูุง ุจุชุฑ `, true);
                }
                
                gameState.players = gameState.players.map((p, i) => ({
                    ...p,
                    id: 'p' + (i + 1)
                }));
                
                renderSettingsModal();
                adjustModalHeight();
                setStatus(`${removedPlayer.name} ฺฉู ูุฑุณุช ุณ ูนุง ุฏุง ฺฏุง`);
            } else {
                setStatus('ฺฏู ูฺบ ฺฉู ุงุฒ ฺฉู 2 ฺฉฺพูุงฺ ูู ฺุงุฆฺบ!', true);
            }
        };

        const adjustModalHeight = () => {
            const playerCount = gameState.players.length;
            const modalContent = document.querySelector('#settings-modal .bg-white');
            
            if (playerCount > 4) {
                modalContent.style.maxHeight = '90vh';
                modalContent.style.overflowY = 'auto';
            } else {
                modalContent.style.maxHeight = 'auto';
                modalContent.style.overflowY = 'visible';
            }
        };

        const handleCreateNewGameFromSettings = async () => {
            const customPlayerInputs = document.querySelectorAll('.new-player-input');
            const customPlayerNames = Array.from(customPlayerInputs).map(input => input.value.trim()).filter(name => name);
            
            if (customPlayerNames.length < 2) {
                setStatus('ฺฉู ุงุฒ ฺฉู 2 ฺฉฺพูุงฺูฺบ ฺฉ ูุงู ุฏุฑุฌ ฺฉุฑฺบ', true);
                return;
            }

            ui.settingsModal.classList.add('hidden');
            
            // Save current game to records before resetting
            if (gameState.history.length > 0) {
                await handleRecordGame();
            }
            
            // Create new game with custom names
            const playerNames = customPlayerNames.length > 0 ? customPlayerNames : gameState.players.map(p => p.name);
            
            gameState = {
                ...DEFAULT_GAME_STATE,
                players: playerNames.map((name, index) => ({
                    id: 'p' + (index + 1),
                    name: name,
                    score: 0
                })),
                gameLimit: gameState.gameLimit,
                deviceId: gameState.deviceId
            };
            
            await saveGameState();
            renderGameUI();
            
            setStatus('ูุฆ ฺฏู ุดุฑูุน ู ฺฏุฆ!');
        };
        
        // ==================== GAME LOGIC ====================
        const validateScoreInputs = () => {
            const inputs = document.querySelectorAll('.score-input');
            let zeroCount = 0;
            let hasNegative = false;
            let allEmpty = true;
            let hasNonNumeric = false;
            
            inputs.forEach(input => {
                const value = input.value.trim();
                const numValue = parseInt(value) || 0;
                
                if (value !== '') allEmpty = false;
                if (numValue === 0) zeroCount++;
                if (numValue < 0) hasNegative = true;
                if (value !== '' && isNaN(numValue)) hasNonNumeric = true;
            });
            
            const isValid = !allEmpty && !hasNegative && !hasNonNumeric && zeroCount === 1;
            ui.saveScoreBtn.disabled = !isValid || gameState.isGameOver || isSaving;
            
            if (!allEmpty) {
                if (hasNegative) {
                    ui.scoreError.textContent = 'ุบูุท: ุณฺฉูุฑ ููู ูฺบ ู ุณฺฉุช';
                    ui.scoreError.classList.remove('hidden');
                } else if (hasNonNumeric) {
                    ui.scoreError.textContent = 'ุบูุท: ุตุฑู ููุจุฑ ุฏุฑุฌ ฺฉุฑฺบ';
                    ui.scoreError.classList.remove('hidden');
                } else if (zeroCount !== 1) {
                    ui.scoreError.textContent = 'ุบูุท: ุตุฑู ุงฺฉ ฺฉฺพูุงฺ ฺฉุง ุณฺฉูุฑ 0 ููุง ฺุง';
                    ui.scoreError.classList.remove('hidden');
                } else {
                    ui.scoreError.classList.add('hidden');
                }
            } else {
                ui.scoreError.classList.add('hidden');
            }
            
            return isValid;
        };

        const handleSaveScore = async () => {
            if (isSaving || gameState.isGameOver) {
                console.log('Saving blocked: isSaving=', isSaving, 'isGameOver=', gameState.isGameOver);
                return;
            }
            
            const inputs = document.querySelectorAll('.score-input');
            const roundScores = [];
            
            inputs.forEach(input => {
                const score = parseInt(input.value) || 0;
                roundScores.push(score);
            });
            
            if (!validateScoreInputs()) {
                setStatus('ุจุฑุง ฺฉุฑู ุฏุฑุณุช ุณฺฉูุฑ ุฏุฑุฌ ฺฉุฑฺบ', true);
                return;
            }
            
            isSaving = true;
            ui.saveScoreBtn.disabled = true;
            ui.saveText.textContent = 'ูุญููุธ ู ุฑุง ...';
            ui.saveSpinner.classList.remove('hidden');
            
            try {
                const nextRoundNumber = gameState.history.length + 1;
                const roundType = getRoundType(nextRoundNumber);
                const multiplier = getRoundMultiplier(roundType);
                
                console.log('Saving round:', { nextRoundNumber, roundType, multiplier, roundScores });
                
                const round = {
                    timestamp: new Date(),
                    scores: [...roundScores],
                    roundType: roundType,
                    multiplier: multiplier,
                    actualScores: roundScores.map(score => score * multiplier)
                };
                
                roundScores.forEach((score, index) => {
                    if (gameState.players[index]) {
                        gameState.players[index].score += score * multiplier;
                    }
                });
                
                gameState.history.unshift(round);
                checkGameOver();
                
                inputs.forEach(input => input.value = '');
                
                renderGameUI();
                
                const saved = saveGameState();
                if (saved) {
                    setStatus(`ุฑุงุคูฺ ${nextRoundNumber} ฺฉุง ุณฺฉูุฑ ฺฉุงูุงุจ ุณ ูุญููุธ ู ฺฏุง! (${getRoundTypeDisplay(roundType)})`);
                } else {
                    setStatus('ุณฺฉูุฑ ูุญููุธ ฺฉุฑู ูฺบ ูุณุฆู ุขุง', true);
                }
                
            } catch (error) {
                console.error('Error saving score:', error);
                setStatus('ุณฺฉูุฑ ูุญููุธ ฺฉุฑู ูฺบ ูุงฺฉุงู: ' + error.message, true);
            } finally {
                isSaving = false;
                ui.saveText.textContent = 'ุณฺฉูุฑ ูุญููุธ ฺฉุฑฺบ';
                ui.saveSpinner.classList.add('hidden');
                validateScoreInputs();
            }
        };

        const checkGameOver = () => {
            const losers = gameState.players.filter(player => 
                player.score >= gameState.gameLimit
            );
            
            if (losers.length > 0) {
                gameState.isGameOver = true;
                const actualLoser = losers.reduce((max, player) => 
                    player.score > max.score ? player : max, losers[0]
                );
                const loserIndex = gameState.players.findIndex(p => p.id === actualLoser.id);
                if (gameState.history.length > 0) {
                    gameState.history[0].loserIndex = loserIndex;
                }
            }
        };

        const handleResetGame = async () => {
            if (!confirm('ฺฉุง ุขูพ ูุงูุน ูุง ฺฏู ุดุฑูุน ฺฉุฑูุง ฺุงุช ฺบุ ููุฌูุฏ ฺฏู ุฑฺฉุงุฑฺ ูฺบ ูุญููุธ ู ุฌุงุฆ ฺฏ')) {
                return;
            }
            
            // Save current game to records before resetting
            if (gameState.history.length > 0) {
                await handleRecordGame();
            }
            
            const playerNames = gameState.players.map(p => p.name);
            gameState = {
                ...DEFAULT_GAME_STATE,
                players: gameState.players.map((p, i) => ({
                    ...p,
                    name: playerNames[i] || p.name,
                    score: 0
                })),
                gameLimit: gameState.gameLimit,
                deviceId: gameState.deviceId,
                history: [],
                isGameOver: false,
                isRecorded: false
            };
            
            saveGameState();
            renderGameUI();
            setStatus('ูุง ฺฏู ุดุฑูุน ู ฺฏุง!');
        };

        // ==================== RECORDS MANAGEMENT ====================
        const handleRecordGame = async () => {
            if (!gameState.isGameOver || gameState.isRecorded) return;

            ui.recordGameBtn.disabled = true;
            ui.recordText.textContent = 'ูุญููุธ ู ุฑุง ...';
            ui.recordSpinner.classList.remove('hidden');
            
            try {
                console.log('Recording game to localStorage...');
                
                const gameRecord = {
                    timestamp: new Date().toISOString(),
                    players: gameState.players,
                    game_limit: gameState.gameLimit,
                    history: gameState.history,
                    final_scores: gameState.players.map(p => p.score),
                    user_id: gameState.deviceId,
                    user_name: currentUser === 'admin' ? 'ุงฺูู' : 'ูุฒุฑ',
                    id: 'record_' + Date.now()
                };
                
                console.log('Game record data:', gameRecord);
                
                const existingRecords = JSON.parse(localStorage.getItem('rummy_records') || '[]');
                existingRecords.unshift(gameRecord);
                localStorage.setItem('rummy_records', JSON.stringify(existingRecords));
                console.log('โ Game recorded successfully in localStorage');
                
                gameState.isRecorded = true;
                saveGameState();
                
                setStatus('ฺฏู ฺฉุงูุงุจ ุณ ูุญููุธ ู ฺฏุฆ!');
                fetchAndRenderRecords(true);
                
            } catch (error) {
                console.error('Error recording game:', error);
                setStatus('ฺฏู ุฑฺฉุงุฑฺ ฺฉุฑู ูฺบ ูุงฺฉุงู: ' + error.message, true);
            } finally {
                ui.recordText.textContent = 'ฺฏู ูุญููุธ ฺฉุฑฺบ';
                ui.recordSpinner.classList.add('hidden');
                ui.recordGameBtn.disabled = gameState.isRecorded;
            }
        };

        const deleteRecord = async (recordId, recordElement) => {
            if (!confirm('ฺฉุง ุขูพ ูุงูุน  ุฑฺฉุงุฑฺ ุดุฏ ฺฏู ุญุฐู ฺฉุฑูุง ฺุงุช ฺบุ  ุนูู ูุงูพุณ ูฺบ ู ุณฺฉุชุง')) {
                return;
            }

            try {
                recordElement.style.opacity = '0.5';
                
                const existingRecords = JSON.parse(localStorage.getItem('rummy_records') || '[]');
                const updatedRecords = existingRecords.filter(record => record.id !== recordId);
                localStorage.setItem('rummy_records', JSON.stringify(updatedRecords));
                console.log('โ Record deleted from localStorage');
                
                recordElement.remove();
                
                const remainingRecords = document.querySelectorAll('.record-item');
                if (remainingRecords.length === 0) {
                    ui.recordsList.innerHTML = '<p class="text-center text-slate-500 urdu-font-normal">ุงุจฺพ ุชฺฉ ฺฉูุฆ ุฑฺฉุงุฑฺ ุดุฏ ฺฏู ูฺบ </p>';
                }
                
                setStatus('ุฑฺฉุงุฑฺ ุดุฏ ฺฏู ฺฉุงูุงุจ ุณ ุญุฐู ู ฺฏุฆ!');
                
            } catch (error) {
                console.error('Error deleting record:', error);
                setStatus('ุฑฺฉุงุฑฺ ุญุฐู ฺฉุฑู ูฺบ ูุงฺฉุงู', true);
                recordElement.style.opacity = '1';
            }
        };

        const fetchAndRenderRecords = async (showRefresh = false) => {
            try {
                if (showRefresh) {
                    ui.recordsList.innerHTML = '<p class="text-center text-slate-500 urdu-font-normal">ฺูนุง ุชุงุฒ ู ุฑุง ...</p>';
                }
                
                const localRecords = JSON.parse(localStorage.getItem('rummy_records') || '[]');
                localRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                renderRecordsList(localRecords.slice(0, 50));
                
            } catch (error) {
                console.error('Error fetching records:', error);
                ui.recordsList.innerHTML = '<p class="text-center text-red-500 urdu-font-normal">ุฑฺฉุงุฑฺุฒ ููฺ ูู ูฺบ ูุงฺฉุงู</p>';
            }
        };

        // ==================== BACKUP/EXPORT SYSTEM ====================
        const showBackupModal = () => {
            // Export current data to textarea
            const exportData = {
                gameState: gameState,
                passwords: passwords,
                records: JSON.parse(localStorage.getItem('rummy_records') || '[]'),
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            ui.exportTextarea.value = JSON.stringify(exportData, null, 2);
            ui.backupModal.classList.remove('hidden');
        };

        const exportData = () => {
            const exportData = {
                gameState: gameState,
                passwords: passwords,
                records: JSON.parse(localStorage.getItem('rummy_records') || '[]'),
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            ui.exportDataDisplay.textContent = dataStr.substring(0, 500) + '...';
            ui.exportDataDisplay.classList.remove('hidden');
            
            // Create download link
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rummy-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            setStatus('ฺูนุง ฺฉุงูุงุจ ุณ ุงฺฉุณูพูุฑูน ู ฺฏุง!');
        };

        const copyExportData = () => {
            ui.exportTextarea.select();
            document.execCommand('copy');
            setStatus('ฺูนุง ฺฉุงูพ ู ฺฏุง! ุงุจ ุขูพ ุงุณ ฺฉุณ ูุญููุธ ุฌฺฏ ูพุณูน ฺฉุฑ ุณฺฉุช ฺบ');
        };

        const importData = () => {
            const importText = ui.importDataInput.value.trim();
            if (!importText) {
                setStatus('ุจุฑุง ฺฉุฑู ุงฺฉุณูพูุฑูน ุดุฏ ฺูนุง ูพุณูน ฺฉุฑฺบ', true);
                return;
            }
            
            try {
                const importedData = JSON.parse(importText);
                
                if (confirm('ฺฉุง ุขูพ ูุงูุน ููุฌูุฏ ฺูนุง ฺฉู ุชุจุฏู ฺฉุฑูุง ฺุงุช ฺบุ  ุนูู ูุงูพุณ ูฺบ ู ุณฺฉุชุง')) {
                    if (importedData.gameState) {
                        gameState = importedData.gameState;
                        localStorage.setItem('rummy_current_game', JSON.stringify(gameState));
                    }
                    
                    if (importedData.passwords) {
                        passwords = importedData.passwords;
                        localStorage.setItem('rummy_passwords', JSON.stringify(passwords));
                    }
                    
                    if (importedData.records) {
                        localStorage.setItem('rummy_records', JSON.stringify(importedData.records));
                    }
                    
                    ui.importDataInput.value = '';
                    renderGameUI();
                    fetchAndRenderRecords();
                    setStatus('ฺูนุง ฺฉุงูุงุจ ุณ ุงููพูุฑูน ู ฺฏุง!');
                }
            } catch (error) {
                console.error('Import error:', error);
                setStatus('ุบูุท ฺูนุง ูุงุฑููน! ุจุฑุง ฺฉุฑู ุฏุฑุณุช ุงฺฉุณูพูุฑูน ุดุฏ ฺูนุง ูพุณูน ฺฉุฑฺบ', true);
            }
        };

        const importBackupData = () => {
            const importText = ui.importTextarea.value.trim();
            if (!importText) {
                setStatus('ุจุฑุง ฺฉุฑู ุงฺฉุณูพูุฑูน ุดุฏ ฺูนุง ูพุณูน ฺฉุฑฺบ', true);
                return;
            }
            
            try {
                const importedData = JSON.parse(importText);
                
                if (confirm('ฺฉุง ุขูพ ูุงูุน ููุฌูุฏ ฺูนุง ฺฉู ุชุจุฏู ฺฉุฑูุง ฺุงุช ฺบุ  ุนูู ูุงูพุณ ูฺบ ู ุณฺฉุชุง')) {
                    if (importedData.gameState) {
                        gameState = importedData.gameState;
                        localStorage.setItem('rummy_current_game', JSON.stringify(gameState));
                    }
                    
                    if (importedData.passwords) {
                        passwords = importedData.passwords;
                        localStorage.setItem('rummy_passwords', JSON.stringify(passwords));
                    }
                    
                    if (importedData.records) {
                        localStorage.setItem('rummy_records', JSON.stringify(importedData.records));
                    }
                    
                    ui.importTextarea.value = '';
                    ui.backupModal.classList.add('hidden');
                    renderGameUI();
                    fetchAndRenderRecords();
                    setStatus('ฺูนุง ฺฉุงูุงุจ ุณ ุงููพูุฑูน ู ฺฏุง!');
                }
            } catch (error) {
                console.error('Import error:', error);
                setStatus('ุบูุท ฺูนุง ูุงุฑููน! ุจุฑุง ฺฉุฑู ุฏุฑุณุช ุงฺฉุณูพูุฑูน ุดุฏ ฺูนุง ูพุณูน ฺฉุฑฺบ', true);
            }
        };

        const clearAllData = () => {
            if (confirm('ฺฉุง ุขูพ ูุงูุน ุชูุงู ฺูนุง ุตุงู ฺฉุฑูุง ฺุงุช ฺบุ  ุนูู ูุงูพุณ ูฺบ ู ุณฺฉุชุง ุงูุฑ ุชูุงู ฺฏูุฒ ุงูุฑ ุฑฺฉุงุฑฺุฒ ุฎุชู ู ุฌุงุฆฺบ ฺฏ')) {
                localStorage.clear();
                location.reload();
            }
        };

        // ==================== STATISTICS SYSTEM ====================
        const showGameStatistics = () => {
            if (gameState.history.length === 0) {
                ui.statsContent.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-slate-500 urdu-font-normal text-lg">ุงุจฺพ ุชฺฉ ฺฉูุฆ ฺูนุง ููุฌูุฏ ูฺบ </p>
                        <p class="text-slate-400 urdu-font-normal mt-2">ฺฉฺฺพ ุฑุงุคูฺ ฺฉฺพูฺบ ุชุงฺฉ ุดูุงุฑุงุช ุฏฺฉฺพ ุณฺฉฺบ</p>
                    </div>
                `;
                ui.statsModal.classList.remove('hidden');
                return;
            }

            const stats = calculateGameStatistics();
            renderStatistics(stats);
            ui.statsModal.classList.remove('hidden');
        };

        const calculateGameStatistics = () => {
            const stats = {
                totalRounds: gameState.history.length,
                totalScore: 0,
                luckyRounds: 0,
                normalRounds: 0,
                playerStats: [],
                gameDuration: calculateGameDuration(),
                averageScores: {}
            };

            gameState.history.forEach(round => {
                stats.totalScore += round.actualScores.reduce((a, b) => a + b, 0);
                if (round.roundType === 'lucky') {
                    stats.luckyRounds++;
                } else {
                    stats.normalRounds++;
                }
            });

            stats.playerStats = gameState.players.map((player, index) => {
                const playerRounds = gameState.history.map(round => ({
                    score: round.scores[index],
                    actualScore: round.actualScores[index],
                    roundType: round.roundType,
                    isZero: round.scores[index] === 0
                }));

                const zeroRounds = playerRounds.filter(round => round.isZero).length;
                const totalScore = playerRounds.reduce((sum, round) => sum + round.actualScore, 0);
                const averageScore = totalScore / stats.totalRounds;
                const maxScore = Math.max(...playerRounds.map(round => round.actualScore));
                const minScore = Math.min(...playerRounds.map(round => round.actualScore));

                return {
                    name: player.name,
                    currentScore: player.score,
                    totalScore,
                    averageScore,
                    maxScore,
                    minScore,
                    zeroRounds,
                    winPercentage: ((zeroRounds / stats.totalRounds) * 100).toFixed(1)
                };
            });

            stats.averageScores = {
                perRound: stats.totalScore / stats.totalRounds,
                perPlayer: stats.totalScore / (stats.totalRounds * gameState.players.length)
            };

            return stats;
        };

        const calculateGameDuration = () => {
            if (gameState.history.length === 0) return 'N/A';
            
            const firstRound = gameState.history[gameState.history.length - 1].timestamp;
            const lastRound = gameState.history[0].timestamp;
            const duration = new Date(lastRound) - new Date(firstRound);
            
            const hours = Math.floor(duration / (1000 * 60 * 60));
            const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
            
            return hours > 0 ? `${hours} ฺฏฺพููน ${minutes} ูููน` : `${minutes} ูููน`;
        };

        const renderStatistics = (stats) => {
            const highestScorer = [...stats.playerStats].sort((a, b) => b.currentScore - a.currentScore)[0];
            const mostZeros = [...stats.playerStats].sort((a, b) => b.zeroRounds - a.zeroRounds)[0];
            const bestAverage = [...stats.playerStats].sort((a, b) => a.averageScore - b.averageScore)[0];

            ui.statsContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ฺฉู ุฑุงุคูฺุฒ</div>
                        <div class="stat-value">${stats.totalRounds}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="stat-label">ูฺฉ ฺฏูุฒ</div>
                        <div class="stat-value">${stats.luckyRounds}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <div class="stat-label">ุณุงุฏ ฺฏูุฒ</div>
                        <div class="stat-value">${stats.normalRounds}</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="stat-label">ฺฉู ููุช</div>
                        <div class="stat-value">${stats.gameDuration}</div>
                    </div>
                </div>

                <div class="bg-cyan-50 border border-cyan-200 rounded-xl p-4 mb-6">
                    <h3 class="text-lg urdu-font-bold text-cyan-800 mb-3">ฺฉูุฏ ฺฉุงุฑฺฉุฑุฏฺฏ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="text-center">
                            <div class="urdu-font-normal text-cyan-600">ุณุจ ุณ ุฒุงุฏ ุงุณฺฉูุฑ</div>
                            <div class="urdu-font-bold text-cyan-800">${highestScorer.name}</div>
                            <div class="text-xs text-cyan-600">${formatScore(highestScorer.currentScore)} ูพูุงุฆููนุณ</div>
                        </div>
                        <div class="text-center">
                            <div class="urdu-font-normal text-cyan-600">ุณุจ ุณ ุฒุงุฏ ุฌุช</div>
                            <div class="urdu-font-bold text-cyan-800">${mostZeros.name}</div>
                            <div class="text-xs text-cyan-600">${mostZeros.zeroRounds} ุฑุงุคูฺ (${mostZeros.winPercentage}%)</div>
                        </div>
                        <div class="text-center">
                            <div class="urdu-font-normal text-cyan-600">ุจุชุฑู ุงูุณุท</div>
                            <div class="urdu-font-bold text-cyan-800">${bestAverage.name}</div>
                            <div class="text-xs text-cyan-600">${formatScore(Math.round(bestAverage.averageScore))} ู ุฑุงุคูฺ</div>
                        </div>
                    </div>
                </div>

                <h3 class="text-xl urdu-font-bold mb-4">ฺฉฺพูุงฺูฺบ ฺฉ ุชูุตู ฺฉุงุฑฺฉุฑุฏฺฏ</h3>
                <div class="space-y-4">
                    ${stats.playerStats.map(playerStat => `
                        <div class="player-stats">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="urdu-font-bold text-lg text-slate-800">${playerStat.name}</h4>
                                <span class="urdu-font-bold text-cyan-600">${formatScore(playerStat.currentScore)} ูพูุงุฆููนุณ</span>
                            </div>
                            
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-3">
                                <div>
                                    <div class="urdu-font-normal text-slate-600">ุงูุณุท ุงุณฺฉูุฑ</div>
                                    <div class="urdu-font-bold text-slate-800">${formatScore(Math.round(playerStat.averageScore))}</div>
                                </div>
                                <div>
                                    <div class="urdu-font-normal text-slate-600">ุฌุช ฺฉ ุฑุงุคูฺ</div>
                                    <div class="urdu-font-bold text-slate-800">${playerStat.zeroRounds} (${playerStat.winPercentage}%)</div>
                                </div>
                                <div>
                                    <div class="urdu-font-normal text-slate-600">ุฒุงุฏ ุณ ุฒุงุฏ</div>
                                    <div class="urdu-font-bold text-slate-800">${formatScore(playerStat.maxScore)}</div>
                                </div>
                                <div>
                                    <div class="urdu-font-normal text-slate-600">ฺฉู ุณ ฺฉู</div>
                                    <div class="urdu-font-bold text-slate-800">${formatScore(playerStat.minScore)}</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2 text-xs text-slate-600">
                                <span class="urdu-font-normal">ุญุฏ ุชฺฉ ูพูฺูุง:</span>
                                <div class="flex-1 progress-bar">
                                    <div class="progress-fill" style="width: ${(playerStat.currentScore / gameState.gameLimit) * 100}%"></div>
                                </div>
                                <span class="urdu-font-normal">${Math.round((playerStat.currentScore / gameState.gameLimit) * 100)}%</span>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="mt-6 p-4 bg-slate-50 rounded-xl">
                    <h4 class="urdu-font-bold text-slate-800 mb-2">ฺฏู ฺฉุง ุฎูุงุต</h4>
                    <p class="urdu-font-normal text-slate-600 text-sm">
                        ฺฉู ${stats.totalRounds} ุฑุงุคูฺ ฺฉฺพู ฺฏุฆุ ุฌู ูฺบ ุณ ${stats.luckyRounds} ูฺฉ ฺฏูุฒ ุชฺพฺบ 
                        ุงูุณุทุงู ุฑ ุฑุงุคูฺ ูฺบ ${formatScore(Math.round(stats.averageScores.perRound))} ูพูุงุฆููนุณ ุชูุณู ูุฆ
                        ${gameState.isGameOver ? 'ฺฏู ูฺฉูู ู ฺฺฉ ' : 'ฺฏู ุฌุงุฑ '}
                    </p>
                </div>
            `;
        };

        // ==================== UI RENDERING FUNCTIONS ====================
        const renderGameUI = () => {
            renderScoreboard();
            renderPlayerInputs();
            renderHistory();
            updateGameStatus();
            updateChart();
            updateUIForUserRole();
        };

        const renderScoreboard = () => {
            ui.scoreboardLoading.classList.add('hidden');
            
            const playerCount = gameState.players.length;
            let gridClass;
            if (playerCount === 2) {
                gridClass = 'grid-cols-2';
            } else if (playerCount === 3) {
                gridClass = 'grid-cols-3';
            } else if (playerCount === 5) {
                gridClass = 'grid-cols-2 md:grid-cols-5';
            } else if (playerCount === 6) {
                gridClass = 'grid-cols-2 md:grid-cols-6';
            } else {
                gridClass = 'grid-cols-2 md:grid-cols-4';
            }
            
            ui.scoreboard.className = `grid gap-4 ${gridClass}`;

            ui.scoreboard.innerHTML = gameState.players.map(player => `
                <div class="bg-white p-4 rounded-xl shadow-sm border-2 ${
                    player.score >= gameState.gameLimit ? 'border-red-500 warning-blink' : 
                    player.score >= (gameState.gameLimit - gameState.warningThreshold) ? 'border-yellow-400' : 'border-slate-200'
                } transition-all duration-300">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg urdu-font-bold text-slate-800">${player.name}</h3>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            player.score >= gameState.gameLimit ? 'bg-red-100 text-red-800' : 'bg-slate-100 text-slate-600'
                        } urdu-font-normal">${player.id}</span>
                    </div>
                    <p class="text-3xl urdu-font-bold text-slate-900 text-center my-3">${formatScore(player.score)}</p>
                    <div class="flex justify-between text-sm text-slate-500">
                        <span>ุญุฏ: ${formatScore(gameState.gameLimit)}</span>
                        <span>ูุฑู: ${formatScore(gameState.gameLimit - player.score)}</span>
                    </div>
                </div>
            `).join('');
        };

        const renderPlayerInputs = () => {
            const nextRoundNumber = gameState.history.length + 1;
            const roundType = getRoundType(nextRoundNumber);
            const multiplier = getRoundMultiplier(roundType);
            
            ui.roundTypeIndicator.textContent = `ุฑุงุคูฺ ${nextRoundNumber} - ${getRoundTypeDisplay(roundType)} (${multiplier}x)`;
            ui.roundTypeIndicator.className = `mb-4 p-3 rounded-lg text-center urdu-font-bold text-lg ${
                roundType === 'lucky' ? 'bg-yellow-100 text-yellow-800 lucky-badge' : 'bg-blue-100 text-blue-800 normal-badge'
            }`;
            
            ui.playerInputs.innerHTML = gameState.players.map((player, index) => `
                <div class="flex items-center gap-3">
                    <label class="w-24 text-sm urdu-font-normal text-slate-600">${player.name}</label>
                    <input type="number" 
                           class="score-input flex-1 p-3 border border-slate-300 rounded-lg urdu-font-bold text-lg" 
                           placeholder="0" 
                           min="0"
                           value="">
                </div>
            `).join('');
            
            const newInputs = ui.playerInputs.querySelectorAll('.score-input');
            newInputs.forEach(input => {
                input.addEventListener('input', () => validateScoreInputs());
            });
            
            validateScoreInputs();
        };

        const renderHistory = () => {
            if (gameState.history.length === 0) {
                ui.noHistoryMsg.classList.remove('hidden');
                ui.historyList.innerHTML = '<p id="no-history-msg" class="p-6 text-center text-slate-500 urdu-font-normal">ุงุจฺพ ุชฺฉ ฺฉูุฆ ุฑุงุคูฺ ูฺบ ฺฉฺพูุง ฺฏุง</p>';
                return;
            }
            
            ui.noHistoryMsg.classList.add('hidden');
            
            const playerCount = gameState.players.length;
            const historyGridClass = getPlayerGridClass(playerCount);

            ui.historyList.innerHTML = gameState.history.map((round, index) => {
                const roundNumber = gameState.history.length - index;
                const hasLoser = round.loserIndex !== undefined;
                
                return `
                    <div class="history-item p-4 hover:bg-slate-50 transition-colors relative">
                        <button class="delete-btn p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" 
                                data-round-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                        
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm urdu-font-bold text-slate-700">ุฑุงุคูฺ ${roundNumber}</span>
                                <span class="text-xs px-2 py-1 rounded-full ${
                                    round.roundType === 'lucky' ? 'lucky-badge' : 'normal-badge'
                                } urdu-font-normal">${getRoundTypeDisplay(round.roundType)}</span>
                                ${hasLoser ? '<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded urdu-font-normal">ฺฏู ุฎุชู</span>' : ''}
                            </div>
                            <span class="text-xs text-slate-500">${new Date(round.timestamp?.toDate?.() || round.timestamp).toLocaleTimeString('ur-PK')}</span>
                        </div>
                        
                        <div class="grid gap-2 ${historyGridClass}"> 
                            ${round.scores.map((score, playerIndex) => `
                                <div class="text-center p-2 rounded-lg ${
                                    score === 0 ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-700'
                                }">
                                    <div class="text-sm urdu-font-normal">${gameState.players[playerIndex]?.name || 'ูุงูุนููู'}</div>
                                    <div class="text-lg urdu-font-bold">${formatScore(score)}</div>
                                    ${round.multiplier > 1 ? 
                                        `<div class="text-xs text-slate-500">(${formatScore(round.actualScores[playerIndex])})</div>` : ''
                                    }
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const roundIndex = parseInt(e.currentTarget.dataset.roundIndex);
                    await deleteRound(roundIndex);
                });
            });
        };

        const deleteRound = async (roundIndex) => {
            if (!confirm('ฺฉุง ุขูพ ูุงูุน  ุฑุงุคูฺ ุญุฐู ฺฉุฑูุง ฺุงุช ฺบุ ุงุณ ุฑุงุคูฺ ฺฉ ุณฺฉูุฑ ุชูุงู ฺฉฺพูุงฺูฺบ ฺฉ ฺฉู ุณฺฉูุฑ ุณ ููุง ฺฉุฑ ุฏ ุฌุงุฆฺบ ฺฏ')) {
                return;
            }
            
            try {
                const removedRound = gameState.history[roundIndex];
                
                removedRound.actualScores.forEach((score, index) => {
                    if(gameState.players[index]) {
                        gameState.players[index].score -= score;
                    }
                });
                
                gameState.history.splice(roundIndex, 1);
                
                gameState.isGameOver = false;
                gameState.isRecorded = false;
                checkGameOver();
                
                saveGameState();
                renderGameUI();
                setStatus('ุฑุงุคูฺ ฺฉุงูุงุจ ุณ ุญุฐู ู ฺฏุง!');
                
            } catch (error) {
                console.error('Error deleting round:', error);
                setStatus('ุฑุงุคูฺ ุญุฐู ฺฉุฑู ูฺบ ูุงฺฉุงู', true);
            }
        };

        const renderSettingsModal = () => {
            ui.gameLimitInput.value = gameState.gameLimit;
            
            updatePlayerCountButtons();
            
            ui.playerNameInputs.innerHTML = gameState.players.map((player, index) => `
                <div class="mb-3">
                    <label for="player-name-${index}" class="block text-sm urdu-font-normal text-slate-600 mb-1">ฺฉฺพูุงฺ ${index + 1} (ID: ${player.id})</label>
                    <input type="text" 
                           id="player-name-${index}" 
                           class="w-full p-2 border border-slate-300 rounded-lg text-center urdu-font-normal" 
                           value="${player.name}">
                </div>
            `).join('');

            ui.newPlayerNameInputs.innerHTML = gameState.players.map((player, index) => `
                <input type="text" 
                       class="new-player-input w-full p-2 border border-slate-300 rounded-lg mb-2 text-center urdu-font-normal" 
                       value="${player.name}" 
                       placeholder="ฺฉฺพูุงฺ ${index + 1}">
            `).join('');

            adjustModalHeight();
        };

        const handleSaveSettings = async () => {
            const newLimit = parseInt(ui.gameLimitInput.value);
            
            if (newLimit < 100) {
                setStatus('ฺฏู ฺฉ ุญุฏ ฺฉู ุงุฒ ฺฉู 100 ูู ฺุง', true);
                return;
            }
            
            const updatedPlayers = gameState.players.map((player, index) => {
                const input = document.getElementById(`player-name-${index}`);
                return {
                    id: player.id,
                    name: input.value.trim() || `ฺฉฺพูุงฺ ${index + 1}`,
                    score: player.score
                };
            });
            
            gameState.gameLimit = newLimit;
            gameState.players = updatedPlayers;
            
            const saved = saveGameState();
            if (saved) {
                ui.settingsModal.classList.add('hidden');
                renderGameUI();
                setStatus('ุชุฑุชุจุงุช ูุญููุธ ู ฺฏุฆฺบ!');
            }
        };

        const updateGameStatus = () => {
            ui.limitDisplayHeader.textContent = formatScore(gameState.gameLimit);
            
            if (gameState.isGameOver) {
                const losers = gameState.players.filter(p => p.score >= gameState.gameLimit);
                const actualLoser = losers.reduce((max, player) => 
                    player.score > max.score ? player : max, losers[0]
                );
                
                ui.gameOverMessage.classList.remove('hidden');
                ui.gameOverMessage.querySelector('p').textContent = 
                    `๐ฏ ฺฏู ุฎุชู! ${actualLoser.name} ุงุฑ ฺฏุฆ ูุงุฆูู ุณฺฉูุฑ: ${formatScore(actualLoser.score)}`;
                
                ui.resetGameBtn.classList.remove('hidden');
                ui.recordGameBtn.classList.remove('hidden');
                
                ui.recordGameBtn.disabled = gameState.isRecorded;
                
                if (gameState.isRecorded) {
                    ui.recordText.textContent = 'โ ูุญููุธ ู ฺฺฉ';
                }
            } else {
                ui.gameOverMessage.classList.add('hidden');
                ui.resetGameBtn.classList.add('hidden');
                ui.recordGameBtn.classList.add('hidden');
            }
        };

        const updateChart = () => {
            const ctx = ui.chartCanvas.getContext('2d');
            
            if (scoreChart) {
                scoreChart.destroy();
            }
            
            if (gameState.history.length === 0) {
                return;
            }
            
            const labels = gameState.history.map((_, index) => `ุฑุงุคูฺ ${gameState.history.length - index}`).reverse();
            const datasets = gameState.players.map((player, playerIndex) => {
                const color = getPlayerColor(playerIndex);
                const cumulativeScores = [];
                let total = 0;
                
                [...gameState.history].reverse().forEach(round => {
                    const score = round.actualScores[playerIndex] || 0;
                    total += score;
                    cumulativeScores.push(total);
                });
                
                return {
                    label: player.name,
                    data: cumulativeScores,
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: color,
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });
            
            scoreChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true,
                            labels: {
                                font: {
                                    family: "'Noto Nastaliq Urdu', serif",
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            rtl: true,
                            titleFont: {
                                family: "'Noto Nastaliq Urdu', serif"
                            },
                            bodyFont: {
                                family: "'Noto Nastaliq Urdu', serif"
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    family: "'Noto Nastaliq Urdu', serif"
                                },
                                maxRotation: 45
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    family: "'Noto Nastaliq Urdu', serif"
                                },
                                callback: function(value) {
                                    return formatScore(value);
                                }
                            }
                        }
                    }
                }
            });
        };

        const getPlayerColor = (index) => {
            const colors = [
                '#06b6d4',
                '#8b5cf6',
                '#10b981',
                '#f59e0b',
                '#ef4444',
                '#3b82f6'
            ];
            return colors[index % colors.length];
        };

        const renderRecordsList = (records) => {
            if (records.length === 0) {
                ui.recordsList.innerHTML = '<p class="text-center text-slate-500 urdu-font-normal">ุงุจฺพ ุชฺฉ ฺฉูุฆ ุฑฺฉุงุฑฺ ุดุฏ ฺฏู ูฺบ </p>';
                return;
            }
            
            const isAdmin = currentUser === 'admin';
            
            ui.recordsList.innerHTML = records.map(record => {
                const timestamp = record.timestamp?.toDate?.() || new Date(record.timestamp) || new Date();
                const players = record.players || [];
                if (players.length === 0) return '';
                
                const winner = players.reduce((min, player) => 
                    player.score < min.score ? player : min, players[0]
                );
                
                const recordGridClass = getPlayerGridClass(players.length);
                
                return `
                    <div class="record-item p-4 border border-slate-200 rounded-lg mb-3 hover:bg-slate-50 transition-colors cursor-pointer" data-record-id="${record.id || 'local'}">
                        ${isAdmin ? `
                        <button class="delete-record-btn urdu-font-normal" data-record-id="${record.id || 'local'}">
                            ๐๏ธ ุญุฐู ฺฉุฑฺบ
                        </button>
                        ` : ''}
                        
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="urdu-font-bold text-slate-800">${timestamp.toLocaleDateString('ur-PK')}</h3>
                                <p class="text-sm text-slate-600 urdu-font-normal">${timestamp.toLocaleTimeString('ur-PK')}</p>
                            </div>
                            <span class="text-xs bg-cyan-100 text-cyan-800 px-2 py-1 rounded urdu-font-normal">ุญุฏ: ${formatScore(record.game_limit || record.gameLimit)}</span>
                        </div>
                        
                        <div class="grid gap-2 mb-3 ${recordGridClass}">
                            ${players.map(player => `
                                <div class="text-center p-2 rounded-lg ${
                                    player.id === winner.id ? 'bg-green-100 text-green-800 border border-green-300' : 'bg-slate-100 text-slate-700'
                                }">
                                    <div class="text-sm urdu-font-normal">${player.name}</div>
                                    <div class="text-lg urdu-font-bold">${formatScore(player.score)}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="flex justify-between items-center text-xs text-slate-500">
                            <span class="urdu-font-normal">ูุงุชุญ: ${winner.name}</span>
                            <span class="urdu-font-normal">ุฑุงุคูฺุฒ: ${record.history?.length || 0}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.querySelectorAll('.record-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-record-btn') || e.target.closest('.delete-record-btn')) {
                        return;
                    }
                    const recordId = e.currentTarget.dataset.recordId;
                    const record = records.find(r => r.id === recordId);
                    if (record) {
                        showRecordDetails(record);
                    }
                });
            });
            
            if (isAdmin) {
                document.querySelectorAll('.delete-record-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const recordId = e.currentTarget.dataset.recordId;
                        const recordElement = e.currentTarget.closest('.record-item');
                        deleteRecord(recordId, recordElement);
                    });
                });
            }
        };

        const showRecordDetails = (record) => {
            const players = record.players || [];
            if (players.length === 0) return;

            const winner = players.reduce((min, player) => 
                player.score < min.score ? player : min, players[0]
            );
            
            const detailGridClass = getPlayerGridClass(players.length);

            ui.recordDetailsContent.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-xl urdu-font-bold mb-4 text-center">ูุงุฆูู ุณฺฉูุฑ ุจูุฑฺ</h3>
                    <div class="grid gap-4 ${detailGridClass}">
                        ${players.map(player => `
                            <div class="text-center p-4 rounded-xl ${
                                player.id === winner.id ? 'bg-green-100 border-2 border-green-400' : 'bg-slate-100 border border-slate-300'
                            }">
                                <div class="text-lg urdu-font-bold mb-2 ${player.id === winner.id ? 'text-green-800' : 'text-slate-800'}">${player.name}</div>
                                <div class="text-2xl urdu-font-bold ${player.id === winner.id ? 'text-green-900' : 'text-slate-900'}">${formatScore(player.score)}</div>
                                ${player.id === winner.id ? 
                                    '<div class="mt-2 text-sm urdu-font-normal text-green-700">๐ ูุงุชุญ</div>' : 
                                    `<div class="mt-2 text-sm urdu-font-normal text-slate-600">ูุฑู: ${formatScore(player.score - winner.score)}</div>`
                                }
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div>
                    <h4 class="text-lg urdu-font-bold mb-3">ุชูุงู ุฑุงุคูฺุฒ ฺฉ ุชูุตู</h4>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        ${(record.history || []).map((round, index) => {
                            const roundNumber = index + 1;
                            const roundType = getRoundType(roundNumber);
                            
                            return `
                                <div class="round-detail-item p-3 border border-slate-200 rounded-lg">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="urdu-font-bold text-slate-700">ุฑุงุคูฺ ${roundNumber}</span>
                                        <span class="text-xs px-2 py-1 rounded-full ${
                                            roundType === 'lucky' ? 'lucky-badge' : 'normal-badge'
                                        } urdu-font-normal">${getRoundTypeDisplay(roundType)}</span>
                                    </div>
                                    <div class="grid gap-2 ${detailGridClass}">
                                        ${round.scores.map((score, playerIndex) => `
                                            <div class="text-center p-2 rounded ${
                                                score === 0 ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-700'
                                            }">
                                                <div class="text-sm urdu-font-normal">${players[playerIndex]?.name || 'ูุงูุนููู'}</div>
                                                <div class="urdu-font-bold">${formatScore(score)}</div>
                                                ${round.multiplier > 1 ? 
                                                    `<div class="text-xs text-slate-500">(${formatScore(round.actualScores[playerIndex])})</div>` : ''
                                                }
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            ui.recordDetailsModal.classList.remove('hidden');
        };

        // ==================== INITIALIZE APP ====================
        const initializeApp = async () => {
            initializeEventListeners();
            
            try {
                // Check if user is already logged in
                const savedUser = localStorage.getItem('rummy_current_user');
                const autoLogin = localStorage.getItem('rummy_auto_login');
                
                if (savedUser && autoLogin === 'true') {
                    currentUser = savedUser;
                    showMainApp();
                    ui.loadingOverlay.classList.add('hidden');
                    return;
                }
                
                // Load game state
                loadGameState();
                renderGameUI();
                fetchAndRenderRecords();
                
                // Hide loading after 1 second
                setTimeout(() => {
                    ui.loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => ui.loadingOverlay.classList.add('hidden'), 500);
                }, 1000);
                
            } catch (error) {
                console.error('Initialization failed:', error);
                setStatus('ุงูพ ุดุฑูุน ฺฉุฑู ูฺบ ูุงฺฉุงู', true);
                ui.loadingOverlay.classList.add('hidden');
            }
        };

        // Start the application
        initializeLoginSystem();
        
        // Auto start if in Appsgeyser (bypass login)
        setTimeout(() => {
            if (ui.loadingOverlay.classList.contains('hidden') === false) {
                // If still on loading screen after 3 seconds, auto login
                const savedUser = localStorage.getItem('rummy_current_user');
                if (!savedUser) {
                    currentUser = 'user';
                    localStorage.setItem('rummy_current_user', 'user');
                    localStorage.setItem('rummy_auto_login', 'true');
                    showMainApp();
                    ui.loadingOverlay.classList.add('hidden');
                    console.log('Auto-login activated for Appsgeyser');
                }
            }
        }, 3000);
    </script>
</body>
</html>