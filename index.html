<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>رمی سکور ٹریکر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Nastaliq Urdu', serif;
            background-color: #f8fafc;
        }
        .urdu-font-bold { font-weight: 700; }
        .urdu-font-normal { font-weight: 400; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 40vh;
        }
        @media (min-width: 640px) {
            .chart-container { height: 350px; }
        }
        .warning-blink {
            animation: border-blink 1.5s infinite ease-in-out;
            box-shadow: 0 0 16px rgba(234, 179, 8, 0.6);
        }
        @keyframes border-blink {
            0% { border-color: #f59e0b; }
            50% { border-color: #fef3c7; }
            100% { border-color: #f59e0b; }
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #06b6d4;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .score-input { text-align: center !important; }
        .delete-btn {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .history-item:hover .delete-btn { opacity: 1; }
        .record-details-modal {
            max-height: 80vh;
            overflow-y: auto;
        }
        .round-detail-item { transition: background-color 0.2s; }
        .round-detail-item:hover { background-color: #f8fafc; }
        .lucky-badge {
            background-color: #fef3c7;
            color: #d97706;
            border: 1px solid #f59e0b;
        }
        .normal-badge {
            background-color: #dbeafe;
            color: #1d4ed8;
            border: 1px solid #3b82f6;
        }
    </style>
</head>
<body class="text-slate-800">
    <div id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Loading Indicator -->
        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50 transition-opacity duration-500">
            <div class="flex flex-col items-center">
                <div class="loader"></div>
                <p id="loading-text" class="mt-3 urdu-font-bold text-slate-700">ڈیٹا لوڈ ہو رہا ہے...</p>
                <p id="auth-status" class="mt-1 text-xs text-slate-500">تصدیق کی جا رہی ہے...</p>
            </div>
        </div>

        <header class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
            <div>
                <h1 class="text-3xl md:text-4xl urdu-font-bold text-slate-900">رمی ڈیش بورڈ</h1>
                <div class="flex items-center gap-2 mt-1">
                    <p id="user-info" class="text-xs text-slate-400 urdu-font-normal">یوزر آئی ڈی:</p>
                    <span id="user-id-display" class="text-sm text-cyan-600 urdu-font-bold">...</span>
                </div>
                <p id="game-status" class="text-slate-500 urdu-font-normal mt-1">کھیل جاری ہے، حد <span id="limit-display-header" class="urdu-font-bold">800</span> ہے۔</p>
            </div>
            <button id="settings-btn" aria-label="ترتیبات" class="p-3 rounded-full hover:bg-slate-200 transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </header>

        <main>
            <!-- Scoreboard Section -->
            <section id="scoreboard-section" class="mb-8">
                <h2 class="text-2xl urdu-font-bold mb-4">موجودہ سکور بورڈ</h2>
                 <div id="game-over-message" class="hidden p-4 mb-4 text-center bg-red-100 border-r-4 border-red-500 text-red-700 rounded-lg">
                    <p class="urdu-font-bold text-xl mb-3"></p>
                    <div class="flex flex-col sm:flex-row justify-center gap-3">
                         <button id="record-game-btn" disabled class="hidden px-4 py-2 bg-purple-600 text-white urdu-font-normal rounded-lg hover:bg-purple-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            <span id="record-text">گیم ریکارڈ کریں</span>
                            <div id="record-spinner" class="loader hidden w-4 h-4"></div>
                        </button>
                        <button id="reset-game-btn" disabled class="hidden px-4 py-2 bg-cyan-600 text-white urdu-font-normal rounded-lg hover:bg-cyan-700 transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                             نیا گیم شروع کریں 
                        </button>
                    </div>
                </div>
                <div id="scoreboard" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                     <p class="col-span-2 md:col-span-4 text-center text-slate-400 urdu-font-normal" id="scoreboard-loading">سکور بورڈ لوڈ ہو رہا ہے...</p>
                </div>
            </section>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-2">
                     <section id="input-section" class="bg-white p-6 rounded-2xl shadow-md border border-slate-200 h-full">
                        <h2 class="text-2xl urdu-font-bold mb-4">نیا راؤنڈ درج کریں</h2>
                        <div id="round-type-indicator" class="mb-4 p-3 rounded-lg text-center urdu-font-bold text-lg"></div>
                        <div class="space-y-4">
                            <div id="player-inputs"></div>
                             <p id="score-error" class="text-red-600 text-sm hidden urdu-font-normal">غلطی: ایک کھلاڑی کا سکور 0 ہونا چاہئے، اور باقیوں کا 0 سے زیادہ۔</p>
                            <button id="save-score-btn" disabled class="w-full bg-cyan-600 text-white urdu-font-bold py-3 px-4 rounded-lg hover:bg-cyan-700 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors duration-200 flex items-center justify-center gap-2">
                                <span id="save-text">سکور محفوظ کریں</span>
                                <div id="save-spinner" class="loader hidden w-4 h-4"></div>
                            </button>
                        </div>
                    </section>
                </div>
                <div class="lg:col-span-3">
                     <section id="chart-section" class="bg-white p-6 rounded-2xl shadow-md border border-slate-200">
                        <h2 class="text-2xl urdu-font-bold mb-4">سکور کا گراف</h2>
                        <p class="text-sm text-slate-500 urdu-font-normal mb-3">یہ گراف ہر کھلاڑی کے کل سکور کو ہر راؤنڈ کے بعد ظاہر کرتا ہے۔</p>
                        <div class="chart-container">
                            <canvas id="score-chart"></canvas>
                        </div>
                    </section>
                </div>
            </div>

            <!-- History Section -->
            <section id="history-section" class="mt-8">
                <h2 class="text-2xl urdu-font-bold mb-4">راؤنڈ کی تاریخ</h2>
                <div class="bg-white rounded-2xl shadow-md border border-slate-200">
                    <div id="history-list" class="divide-y divide-slate-200">
                        <p id="no-history-msg" class="p-6 text-center text-slate-500 urdu-font-normal">ابھی تک کوئی راؤنڈ نہیں کھیلا گیا۔</p>
                    </div>
                </div>
            </section>
            
            <!-- Records Section -->
            <section id="records-section" class="mt-8">
                <h2 class="text-2xl urdu-font-bold mb-4 flex justify-between items-center">
                    ریکارڈ شدہ گیمز
                    <button id="refresh-records-btn" class="text-sm urdu-font-normal text-cyan-600 hover:text-cyan-800 transition-colors flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6"></path><path d="M2.5 22v-6h6"></path><path d="M2.5 16a10 10 0 0 1 18.5-4.5M21.5 8a10 10 0 0 1-18.5 4.5"></path></svg>
                         تازہ کریں
                    </button>
                </h2>
                <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-4">
                    <div id="records-list">
                        <p class="text-center text-slate-500 urdu-font-normal" id="records-loading-msg">ریکارڈز لوڈ ہو رہے ہیں...</p>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md">
            <h2 class="text-2xl urdu-font-bold mb-6 text-center">ترتیبات</h2>
            <div class="space-y-4">
                <div>
                    <label for="game-limit-input" class="block text-sm urdu-font-normal text-slate-600 mb-1">گیم کی حد (لوزر سکور)</label>
                    <input type="number" id="game-limit-input" min="100" class="w-full p-2 border border-slate-300 rounded-lg text-center" value="800">
                </div>
                <div id="player-name-inputs"></div>
            </div>
            <div class="mt-8 flex justify-end gap-4">
                <button id="cancel-settings-btn" class="px-4 py-2 bg-slate-200 text-slate-800 urdu-font-normal rounded-lg hover:bg-slate-300 transition-colors">منسوخ</button>
                <button id="save-settings-btn" class="px-4 py-2 bg-cyan-600 text-white urdu-font-bold rounded-lg hover:bg-cyan-700 transition-colors">محفوظ کریں</button>
            </div>
        </div>
    </div>

    <!-- Record Details Modal -->
    <div id="record-details-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-4xl record-details-modal">
            <h2 class="text-2xl urdu-font-bold mb-6 text-center">گیم کی مکمل تفصیل</h2>
            <div id="record-details-content"></div>
            <div class="mt-8 flex justify-end">
                <button id="close-record-details-btn" class="px-4 py-2 bg-slate-200 text-slate-800 urdu-font-normal rounded-lg hover:bg-slate-300 transition-colors">بند کریں</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, addDoc, deleteDoc, runTransaction, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables are provided by the Canvas environment
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        let userId = 'loading'; // Will be updated after auth

        // Default State
        const DEFAULT_GAME_STATE = {
            players: [
                { id: 'p1', name: 'معظم', score: 0 },
                { id: 'p2', name: 'اقسام', score: 0 },
                { id: 'p3', name: 'وقار', score: 0 },
                { id: 'p4', name: 'زاہد', score: 0 },
            ],
            gameLimit: 800,
            warningThreshold: 100,
            history: [],
            isGameOver: false,
            isRecorded: false,
        };

        let gameState = {...DEFAULT_GAME_STATE};

        // Firestore Paths (using the required artifact structure)
        const getCurrentGameRef = () => doc(db, 'artifacts', appId, 'users', userId, 'game_state', 'current_game');
        const getRecordsCollectionRef = () => collection(db, 'artifacts', appId, 'users', userId, 'recorded_games');


        // UI Elements
        const ui = {
            loadingOverlay: document.getElementById('loading-overlay'),
            loadingText: document.getElementById('loading-text'),
            authStatus: document.getElementById('auth-status'),
            userIdDisplay: document.getElementById('user-id-display'),
            gameStatus: document.getElementById('game-status'),
            limitDisplayHeader: document.getElementById('limit-display-header'),
            scoreboard: document.getElementById('scoreboard'),
            scoreboardLoading: document.getElementById('scoreboard-loading'),
            gameOverMessage: document.getElementById('game-over-message'),
            resetGameBtn: document.getElementById('reset-game-btn'),
            recordGameBtn: document.getElementById('record-game-btn'),
            recordText: document.getElementById('record-text'),
            recordSpinner: document.getElementById('record-spinner'),
            playerInputs: document.getElementById('player-inputs'),
            scoreError: document.getElementById('score-error'),
            saveScoreBtn: document.getElementById('save-score-btn'),
            saveText: document.getElementById('save-text'),
            saveSpinner: document.getElementById('save-spinner'),
            historyList: document.getElementById('history-list'),
            noHistoryMsg: document.getElementById('no-history-msg'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            gameLimitInput: document.getElementById('game-limit-input'),
            playerNameInputs: document.getElementById('player-name-inputs'),
            cancelSettingsBtn: document.getElementById('cancel-settings-btn'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            chartCanvas: document.getElementById('score-chart'),
            recordsList: document.getElementById('records-list'),
            refreshRecordsBtn: document.getElementById('refresh-records-btn'),
            recordDetailsModal: document.getElementById('record-details-modal'),
            recordDetailsContent: document.getElementById('record-details-content'),
            closeRecordDetailsBtn: document.getElementById('close-record-details-btn'),
            roundTypeIndicator: document.getElementById('round-type-indicator'),
        };

        let scoreChart;
        let isSaving = false;

        // Utility Functions
        const formatScore = (score) => score.toLocaleString('ur-PK');

        const getRoundType = (roundNumber) => {
            const cyclePosition = (roundNumber - 1) % 5;
            // Rounds 1 and 2 are lucky (double score), 3, 4, 5 are normal.
            return cyclePosition < 2 ? 'lucky' : 'normal'; 
        };

        const getRoundTypeDisplay = (roundType) => {
            return roundType === 'lucky' ? 'لکی گیم' : 'سادہ گیم';
        };

        const getRoundMultiplier = (roundType) => {
            return roundType === 'lucky' ? 2 : 1;
        };

        const setStatus = (message, isError = false) => {
            const existingStatus = document.querySelector('.status-message');
            if (existingStatus) existingStatus.remove();
            
            const statusBox = document.createElement('div');
            statusBox.className = `status-message p-3 mb-4 text-center rounded-lg urdu-font-normal ${isError ? 'bg-red-100 text-red-700' : 'bg-cyan-100 text-cyan-700'}`;
            statusBox.textContent = message;
            document.querySelector('main').prepend(statusBox);
            setTimeout(() => statusBox.remove(), 5000);
        };

        // Event Listeners
        const initializeEventListeners = () => {
            ui.resetGameBtn.addEventListener('click', handleResetGame);
            ui.saveScoreBtn.addEventListener('click', handleSaveScore);
            ui.recordGameBtn.addEventListener('click', handleRecordGame);
            ui.refreshRecordsBtn.addEventListener('click', () => fetchAndRenderRecords(true));
            ui.settingsBtn.addEventListener('click', () => {
                if (auth && auth.currentUser) {
                    ui.settingsModal.classList.remove('hidden');
                    renderSettingsModal();
                } else {
                     setStatus('ڈیٹا لوڈ ہونے کا انتظار ہے...', true);
                }
            });
            ui.cancelSettingsBtn.addEventListener('click', () => {
                ui.settingsModal.classList.add('hidden');
            });
            ui.saveSettingsBtn.addEventListener('click', handleSaveSettings);
            ui.closeRecordDetailsBtn.addEventListener('click', () => {
                ui.recordDetailsModal.classList.add('hidden');
            });
            ui.playerInputs.addEventListener('input', (e) => {
                 if (e.target.classList.contains('score-input')) {
                    validateScoreInputs();
                 }
            });
        };

        // --- FIREBASE DATA MANAGEMENT ---

        const saveGameState = async (newGameState = gameState) => {
            if (!db || !auth.currentUser) return; // Check if Firebase is ready
            try {
                const gameRef = getCurrentGameRef();
                await setDoc(gameRef, newGameState);
                // Snapshot listener will handle the UI update
            } catch (error) {
                console.error('Error saving game state to Firestore:', error);
                setStatus('ڈیٹا کلاؤڈ میں محفوظ کرنے میں ناکامی', true);
            }
        };

        const setupGameStateListener = async () => {
             const gameRef = getCurrentGameRef();
             onSnapshot(gameRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const loadedState = docSnapshot.data();
                    gameState = { ...DEFAULT_GAME_STATE, ...loadedState };
                } else {
                    // Document doesn't exist, initialize it with default state
                    console.log("No current game found, initializing on Firestore.");
                    setDoc(gameRef, DEFAULT_GAME_STATE);
                }
                
                // Always render the UI after the snapshot or initialization
                renderGameUI();
                
                // Hide loading overlay once initial data is ready
                setTimeout(() => {
                    ui.loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => ui.loadingOverlay.classList.add('hidden'), 500);
                }, 500);

            }, (error) => {
                console.error("Snapshot error:", error);
                ui.authStatus.textContent = 'ڈیٹا لوڈ کرنے میں خرابی (Snap Error)';
            });
        };


        // --- GAME LOGIC ---

        const validateScoreInputs = () => {
            const inputs = document.querySelectorAll('.score-input');
            let zeroCount = 0;
            let hasNegative = false;
            let positiveCount = 0;
            let allEmpty = true;
            
            inputs.forEach(input => {
                const value = parseInt(input.value);
                if (input.value !== '') allEmpty = false;
                if (!isNaN(value)) {
                    if (value === 0) zeroCount++;
                    if (value > 0) positiveCount++;
                    if (value < 0) hasNegative = true;
                }
            });
            
            // Valid if: not all empty, no negatives, exactly one zero, and at least one positive score.
            const isValid = !allEmpty && !hasNegative && zeroCount === 1 && positiveCount >= 1;

            ui.saveScoreBtn.disabled = !isValid;
            
            if (!allEmpty && (!isValid || hasNegative)) {
                ui.scoreError.classList.remove('hidden');
                ui.scoreError.textContent = 'غلطی: صرف ایک کھلاڑی کا سکور 0 ہونا چاہیے، باقی مثبت۔';
            } else {
                ui.scoreError.classList.add('hidden');
            }
            
            return isValid;
        };

        const handleSaveScore = async () => {
            if (isSaving || gameState.isGameOver) return;
            
            if (!validateScoreInputs()) {
                setStatus('براہ کرم درست سکور درج کریں۔', true);
                return;
            }

            // Start saving state and UI updates
            isSaving = true;
            ui.saveScoreBtn.disabled = true;
            ui.saveText.textContent = 'محفوظ ہو رہا ہے...';
            ui.saveSpinner.classList.remove('hidden');
            
            try {
                // Use a transaction to ensure atomic update of scores and history
                await runTransaction(db, async (transaction) => {
                    const gameRef = getCurrentGameRef();
                    const doc = await transaction.get(gameRef);

                    if (!doc.exists()) {
                         throw "Document does not exist!";
                    }
                    
                    const currentData = doc.data();
                    // Deep clone history to modify it
                    let newHistory = Array.isArray(currentData.history) ? [...currentData.history] : [];
                    let newPlayers = currentData.players.map(p => ({...p}));
                    
                    const nextRoundNumber = newHistory.length + 1;
                    const roundType = getRoundType(nextRoundNumber);
                    const multiplier = getRoundMultiplier(roundType);
                    
                    const inputs = document.querySelectorAll('.score-input');
                    const roundScores = [];

                    inputs.forEach((input, index) => {
                        const baseScore = parseInt(input.value) || 0;
                        const actualScore = baseScore * multiplier;
                        roundScores.push(baseScore);
                        newPlayers[index].score += actualScore;
                    });

                    const round = {
                        timestamp: new Date().toISOString(), // Use ISO string for safe storage
                        scores: roundScores, // Base scores
                        roundType: roundType,
                        multiplier: multiplier,
                        actualScores: roundScores.map(score => score * multiplier)
                    };
                    
                    newHistory.unshift(round);

                    // Check for Game Over in the new state
                    let isGameOver = currentData.isGameOver;
                    const losers = newPlayers.filter(player => player.score >= currentData.gameLimit);
                    if (losers.length > 0) {
                        isGameOver = true;
                        const actualLoser = losers.reduce((max, player) => 
                            player.score > max.score ? player : max, losers[0]
                        );
                        // Mark the loser in the latest round (which is at index 0)
                        const loserIndex = newPlayers.findIndex(p => p.id === actualLoser.id);
                        newHistory[0].loserIndex = loserIndex;
                    }
                    
                    // Update document in transaction
                    transaction.set(gameRef, {
                        ...currentData,
                        players: newPlayers,
                        history: newHistory,
                        isGameOver: isGameOver,
                        isRecorded: isGameOver ? currentData.isRecorded : false, // Reset recorded status if game is ongoing
                    });
                });
                
                // Clear inputs after successful transaction
                document.querySelectorAll('.score-input').forEach(input => input.value = '');

                setStatus(`راؤنڈ کا سکور کامیابی سے محفوظ ہو گیا! (${getRoundTypeDisplay(getRoundType(gameState.history.length + 1))})`);
                
            } catch (error) {
                console.error('Error saving score:', error);
                setStatus('سکور محفوظ کرنے میں ناکامی', true);
            } finally {
                isSaving = false;
                ui.saveText.textContent = 'سکور محفوظ کریں';
                ui.saveSpinner.classList.add('hidden');
                validateScoreInputs();
            }
        };

        const handleResetGame = async () => {
            if (!db || !auth.currentUser) return;

            // Use a custom modal instead of built-in confirm for consistency
            if (!window.confirm('کیا آپ واقعی نیا گیم شروع کرنا چاہتے ہیں؟ موجودہ ڈیٹا ضائع ہو جائے گا۔')) {
                return;
            }
            
            const playerNames = gameState.players.map(p => p.name);

            const newState = {
                ...DEFAULT_GAME_STATE,
                players: DEFAULT_GAME_STATE.players.map((p, i) => ({
                    ...p,
                    name: playerNames[i] || p.name
                })),
                gameLimit: gameState.gameLimit,
                // Ensure default state is used for dynamic parts
                history: [],
                isGameOver: false,
                isRecorded: false,
            };
            
            await saveGameState(newState);
            setStatus('نیا گیم شروع ہو گیا!');
        };

        const handleDeleteRound = async (roundIndex) => {
            if (!db || !auth.currentUser) return;
            if (!window.confirm('کیا آپ واقعی یہ راؤنڈ حذف کرنا چاہتے ہیں؟ اس سے تمام پچھلے سکور تبدیل ہو جائیں گے۔')) return;
            
            try {
                await runTransaction(db, async (transaction) => {
                    const gameRef = getCurrentGameRef();
                    const doc = await transaction.get(gameRef);

                    if (!doc.exists()) {
                         throw "Document does not exist!";
                    }
                    
                    const currentData = doc.data();
                    let newHistory = Array.isArray(currentData.history) ? [...currentData.history] : [];
                    let newPlayers = currentData.players.map(p => ({...p}));
                    
                    // Remove the round (index is relative to unshifted array)
                    newHistory.splice(roundIndex, 1);
                    
                    // Recalculate all scores
                    newPlayers.forEach(player => player.score = 0);
                    
                    [...newHistory].reverse().forEach((round, histIndex) => { // Iterate oldest to newest for cumulative score
                         const roundNumber = newHistory.length - histIndex;
                         const roundType = round.roundType || getRoundType(roundNumber);
                         const multiplier = round.multiplier || getRoundMultiplier(roundType);
                         
                         round.scores.forEach((score, idx) => {
                             const actualScore = score * multiplier;
                             newPlayers[idx].score += actualScore;
                         });
                    });

                    // Re-check game over status
                    let isGameOver = false;
                    const losers = newPlayers.filter(p => p.score >= currentData.gameLimit);
                    if (losers.length > 0) {
                        isGameOver = true;
                        // No need to set loserIndex on a deleted round, but keep isGameOver logic clean
                    }
                    
                    // Update document in transaction
                    transaction.set(gameRef, {
                        ...currentData,
                        players: newPlayers,
                        history: newHistory,
                        isGameOver: isGameOver,
                        isRecorded: isGameOver ? currentData.isRecorded : false, // Reset recorded status if game state changed
                    });
                });
                
                setStatus('راؤنڈ کامیابی سے حذف ہو گیا!');
                
            } catch (error) {
                console.error('Error deleting round:', error);
                setStatus('راؤنڈ حذف کرنے میں ناکامی', true);
            }
        };

        const handleSaveSettings = async () => {
            if (!db || !auth.currentUser) return;

            try {
                const newLimit = parseInt(ui.gameLimitInput.value) || 800;
                const nameInputs = document.querySelectorAll('.player-name-input');
                const updatedPlayers = gameState.players.map((player, index) => ({
                    ...player,
                    name: nameInputs[index].value || player.name
                }));
                
                const newGameState = {
                    ...gameState,
                    players: updatedPlayers,
                    gameLimit: newLimit,
                };
                
                // Re-check game over status with the new limit
                newGameState.isGameOver = newGameState.players.some(p => p.score >= newLimit);
                newGameState.isRecorded = newGameState.isGameOver ? newGameState.isRecorded : false;

                await saveGameState(newGameState);
                
                ui.settingsModal.classList.add('hidden');
                setStatus('ترتیبات کامیابی سے محفوظ ہو گئیں!');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                setStatus('ترتیبات محفوظ کرنے میں ناکامی', true);
            }
        };


        // --- UI RENDERING ---

        const renderGameUI = () => {
            renderScoreboard();
            renderPlayerInputs();
            renderHistory();
            updateChart();
            updateGameStatus();
        };

        const renderScoreboard = () => {
            const scoreboardEl = document.getElementById('scoreboard');
            if (!scoreboardEl) return;

            const existingLoading = document.getElementById('scoreboard-loading');
            if (existingLoading) existingLoading.remove();

            scoreboardEl.innerHTML = '';
            
            gameState.players.forEach(player => {
                const progress = Math.min((player.score / gameState.gameLimit) * 100, 100);
                const isWarning = player.score >= (gameState.gameLimit - gameState.warningThreshold);
                const isLoser = gameState.isGameOver && player.score >= gameState.gameLimit;
                
                const playerCard = document.createElement('div');
                playerCard.className = `bg-white rounded-xl shadow-sm border-2 p-4 transition-all duration-300 ${
                    isLoser ? 'warning-blink border-red-500 bg-red-50' : 
                    isWarning ? 'warning-blink border-amber-500' : 'border-slate-200'
                }`;
                
                playerCard.innerHTML = `
                    <h3 class="text-lg urdu-font-bold mb-2 ${isLoser ? 'text-red-700' : 'text-slate-700'}">${player.name}</h3>
                    <p class="text-2xl urdu-font-bold mb-3 ${isLoser ? 'text-red-600' : 'text-slate-900'}">${formatScore(player.score)}</p>
                    <div class="w-full bg-slate-200 rounded-full h-3">
                        <div class="h-3 rounded-full transition-all duration-500 ${
                            isLoser ? 'bg-red-600' : 
                            isWarning ? 'bg-amber-500' : 'bg-cyan-600'
                        }" style="width: ${progress}%"></div>
                    </div>
                    <p class="text-xs text-slate-500 mt-2 urdu-font-normal">حد: ${formatScore(gameState.gameLimit)}</p>
                `;
                
                scoreboardEl.appendChild(playerCard);
            });
        };

        const renderHistory = () => {
            if (gameState.history.length === 0) {
                ui.noHistoryMsg.classList.remove('hidden');
                ui.historyList.innerHTML = '';
                ui.historyList.appendChild(ui.noHistoryMsg);
                return;
            }
            
            ui.noHistoryMsg.classList.add('hidden');
            ui.historyList.innerHTML = '';
            
            gameState.history.slice(0, 20).forEach((round, roundIndex) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item relative p-4 hover:bg-slate-50 transition-colors';
                
                const totalRounds = gameState.history.length;
                const roundNumber = totalRounds - roundIndex; // Display round number from 1 to N
                const date = new Date(round.timestamp);
                const timeString = date.toLocaleTimeString('ur-PK', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const roundType = round.roundType || getRoundType(roundNumber);
                const roundTypeText = getRoundTypeDisplay(roundType);
                const badgeClass = roundType === 'lucky' ? 'lucky-badge' : 'normal-badge';
                
                let scoresHtml = gameState.players.map((player, playerIndex) => {
                    const baseScore = round.scores[playerIndex];
                    const actualScore = round.actualScores ? round.actualScores[playerIndex] : (baseScore * (round.multiplier || 1));
                    const isLoser = round.loserIndex === playerIndex;
                    const multiplier = round.multiplier || getRoundMultiplier(roundType);
                    
                    return `
                        <div class="flex justify-between items-center ${isLoser ? 'bg-red-50 -mx-2 px-2 py-1 rounded' : ''}">
                            <div>
                                <span class="urdu-font-normal ${isLoser ? 'text-red-700 font-bold' : ''}">${player.name}</span>
                                ${multiplier > 1 ? `<span class="text-xs text-amber-600 mr-2">(${baseScore} × ${multiplier})</span>` : ''}
                            </div>
                            <span class="urdu-font-bold ${isLoser ? 'text-red-600' : 'text-slate-700'}">${formatScore(actualScore)}</span>
                        </div>
                    `;
                }).join('');
                
                historyItem.innerHTML = `
                    <button class="delete-btn text-red-500 hover:text-red-700 text-sm urdu-font-normal">
                        حذف کریں
                    </button>
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-slate-500 text-sm urdu-font-normal">${timeString}</span>
                        <div class="flex items-center gap-2">
                            <span class="bg-cyan-100 text-cyan-800 text-xs px-2 py-1 rounded urdu-font-normal">راؤنڈ ${roundNumber}</span>
                            <span class="text-xs px-2 py-1 rounded urdu-font-normal ${badgeClass}">${roundTypeText}</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        ${scoresHtml}
                    </div>
                `;
                
                const deleteBtn = historyItem.querySelector('.delete-btn');
                // Use a closure to pass the current index
                deleteBtn.addEventListener('click', () => handleDeleteRound(roundIndex));
                
                ui.historyList.appendChild(historyItem);
            });
        };

        const updateGameStatus = () => {
            ui.limitDisplayHeader.textContent = formatScore(gameState.gameLimit);
            
            // Re-enable/disable input buttons
            ui.saveScoreBtn.disabled = gameState.isGameOver || !validateScoreInputs();
            
            if (gameState.isGameOver) {
                const losers = gameState.players.filter(p => p.score >= gameState.gameLimit);
                const loserNames = losers.map(p => p.name).join('، ');
                
                ui.gameOverMessage.classList.remove('hidden');
                ui.gameOverMessage.querySelector('p').textContent = 
                    `گیم ختم! ${loserNames} نے حد ${formatScore(gameState.gameLimit)} پار کر لی۔`;
                
                ui.resetGameBtn.classList.remove('hidden');
                ui.recordGameBtn.classList.remove('hidden');
                
                ui.recordGameBtn.disabled = gameState.isRecorded;
                ui.resetGameBtn.disabled = false;
                
                ui.gameStatus.innerHTML = `<span class="text-red-600 urdu-font-bold">گیم ختم! ${loserNames} ہار گئے۔</span>`;
            } else {
                ui.gameOverMessage.classList.add('hidden');
                ui.resetGameBtn.classList.add('hidden');
                ui.recordGameBtn.classList.add('hidden');
                ui.gameStatus.textContent = `کھیل جاری ہے، حد ${formatScore(gameState.gameLimit)} ہے۔`;
            }
        };
        
        // Render functions not modified by Firebase migration (kept for completeness)
        const renderPlayerInputs = () => {
            ui.playerInputs.innerHTML = '';
            
            const nextRoundNumber = gameState.history.length + 1;
            const nextRoundType = getRoundType(nextRoundNumber);
            const roundTypeText = getRoundTypeDisplay(nextRoundType);
            const multiplier = getRoundMultiplier(nextRoundType);
            
            const badgeClass = nextRoundType === 'lucky' ? 'lucky-badge' : 'normal-badge';
            ui.roundTypeIndicator.innerHTML = `
                <div class="flex items-center justify-center gap-2">
                    <span>اگلا راؤنڈ:</span>
                    <span class="px-3 py-1 rounded urdu-font-bold ${badgeClass}">${roundTypeText}</span>
                    ${multiplier > 1 ? `<span class="text-sm text-amber-600 mr-2">(سکور ${multiplier} گنا ہوں گے)</span>` : ''}
                </div>
            `;
            
            gameState.players.forEach(player => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'flex flex-col';
                inputGroup.innerHTML = `
                    <label class="text-sm urdu-font-normal text-slate-600 mb-1">${player.name}</label>
                    <input type="number" 
                           class="score-input w-full p-3 border border-slate-300 rounded-lg text-lg text-center" 
                           min="0" 
                           placeholder="0" 
                           inputmode="numeric">
                `;
                ui.playerInputs.appendChild(inputGroup);
            });
            
            validateScoreInputs();
        };

        const renderSettingsModal = () => {
            ui.gameLimitInput.value = gameState.gameLimit;
            ui.playerNameInputs.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'flex flex-col';
                inputGroup.innerHTML = `
                    <label class="block text-sm urdu-font-normal text-slate-600 mb-1">کھلاڑی ${index + 1}</label>
                    <input type="text" 
                           class="player-name-input w-full p-2 border border-slate-300 rounded-lg text-center urdu-font-normal" 
                           value="${player.name}" 
                           maxlength="15">
                `;
                ui.playerNameInputs.appendChild(inputGroup);
            });
        };

        const updateChart = () => {
            const ctx = ui.chartCanvas.getContext('2d');
            
            if (scoreChart) {
                scoreChart.destroy();
            }
            
            if (gameState.history.length === 0) {
                // Clear canvas before drawing
                ctx.clearRect(0, 0, ui.chartCanvas.width, ui.chartCanvas.height);
                ctx.font = "16px 'Noto Nastaliq Urdu'";
                ctx.fillStyle = '#94a3b8';
                ctx.textAlign = 'center';
                ctx.fillText('ابھی تک کوئی ڈیٹا نہیں ہے', ui.chartCanvas.width / 2, ui.chartCanvas.height / 2);
                return;
            }
            
            const labels = [];
            const datasets = gameState.players.map((player, index) => {
                const cumulativeScores = [];
                let runningTotal = 0;
                
                // Iterate oldest to newest (reversed array) for cumulative graph
                [...gameState.history].reverse().forEach((round, roundIndex) => {
                    const roundType = round.roundType || getRoundType(roundIndex + 1);
                    const multiplier = round.multiplier || getRoundMultiplier(roundType);
                    const actualScore = round.actualScores ? round.actualScores[index] : (round.scores[index] * multiplier);
                    
                    runningTotal += actualScore;
                    cumulativeScores.push(runningTotal);
                    
                    if (index === 0) {
                        labels.push(`راؤنڈ ${roundIndex + 1}`);
                    }
                });
                
                return {
                    label: player.name,
                    data: cumulativeScores,
                    borderColor: getPlayerColor(index),
                    backgroundColor: getPlayerColor(index) + '20',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1
                };
            });
            
            scoreChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            rtl: true,
                            labels: { font: { family: "'Noto Nastaliq Urdu', serif" } }
                        },
                        tooltip: {
                            rtl: true,
                            titleFont: { family: "'Noto Nastaliq Urdu', serif" },
                            bodyFont: { family: "'Noto Nastaliq Urdu', serif" }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { font: { family: "'Noto Nastaliq Urdu', serif" } }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { font: { family: "'Noto Nastaliq Urdu', serif" } }
                        }
                    }
                }
            });
        };

        const getPlayerColor = (index) => {
            const colors = ['#06b6d4', '#8b5cf6', '#10b981', '#f59e0b'];
            return colors[index % colors.length];
        };

        // --- RECORDS FUNCTIONALITY (Firestore) ---

        const handleRecordGame = async () => {
            if (!gameState.isGameOver || gameState.isRecorded || isSaving || !db || !auth.currentUser) return;
            
            ui.recordGameBtn.disabled = true;
            ui.recordText.textContent = 'ریکارڈ ہو رہا ہے...';
            ui.recordSpinner.classList.remove('hidden');

            try {
                const recordsCollectionRef = getRecordsCollectionRef();
                const gameRecord = {
                    timestamp: new Date().toISOString(),
                    players: gameState.players,
                    gameLimit: gameState.gameLimit,
                    history: gameState.history,
                    finalScores: gameState.players.map(p => p.score),
                    userId: userId,
                    playerNames: gameState.players.map(p => p.name).join(', ')
                };
                
                await addDoc(recordsCollectionRef, gameRecord);
                
                gameState.isRecorded = true;
                await saveGameState(); // Update current game state to mark as recorded
                
                setStatus('گیم کامیابی سے ریکارڈ ہو گئی!');
                await fetchAndRenderRecords(true);
                
            } catch (error) {
                console.error('Error recording game to Firestore:', error);
                setStatus('گیم ریکارڈ کرنے میں ناکامی', true);
            } finally {
                ui.recordGameBtn.disabled = gameState.isRecorded;
                ui.recordText.textContent = 'گیم ریکارڈ کریں';
                ui.recordSpinner.classList.add('hidden');
            }
        };

        const fetchAndRenderRecords = async (showRefresh = false) => {
            if (!db || !auth.currentUser) return;

            try {
                if (showRefresh) {
                    ui.recordsList.innerHTML = '<p class="text-center text-slate-500 urdu-font-normal">تازہ ہو رہا ہے...</p>';
                }
                
                const recordsCollectionRef = getRecordsCollectionRef();
                // Firestore queries: Cannot use orderBy() here as it requires an index, 
                // so we fetch all and sort client-side.
                const q = query(recordsCollectionRef); 
                const querySnapshot = await getDocs(q);
                
                let records = [];
                querySnapshot.forEach(doc => {
                    records.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by timestamp descending (most recent first)
                records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                renderRecordsList(records);
                
            } catch (error) {
                console.error('Error fetching records from Firestore:', error);
                ui.recordsList.innerHTML = '<p class="text-center text-red-500 urdu-font-normal">ریکارڈز لوڈ ہونے میں ناکامی۔</p>';
            }
        };

        const renderRecordsList = (records) => {
            if (records.length === 0) {
                ui.recordsList.innerHTML = '<p class="text-center text-slate-500 urdu-font-normal">ابھی تک کوئی ریکارڈ شدہ گیم نہیں۔</p>';
                return;
            }
            
            ui.recordsList.innerHTML = '';
            
            records.forEach(record => {
                const recordEl = document.createElement('div');
                recordEl.className = 'p-4 border-b border-slate-200 last:border-b-0';
                
                const date = new Date(record.timestamp);
                const dateString = date.toLocaleDateString('ur-PK', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                const winner = record.players.reduce((min, player) => 
                    player.score < min.score ? player : min, record.players[0]);
                const loser = record.players.reduce((max, player) => 
                    player.score > max.score ? player : max, record.players[0]);
                
                recordEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-slate-700 urdu-font-bold">${dateString}</span>
                        <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded urdu-font-normal">حد: ${formatScore(record.gameLimit)}</span>
                    </div>
                    <div class="space-y-2 mb-3">
                        ${record.players.map(player => `
                            <div class="flex justify-between items-center ${player.id === winner.id ? 'bg-green-50 -mx-2 px-2 py-1 rounded' : ''}">
                                <span class="urdu-font-normal ${player.id === winner.id ? 'text-green-700 font-bold' : 'text-slate-600'}">
                                    ${player.name}
                                    ${player.id === winner.id ? ' 👑' : player.id === loser.id ? ' 💀' : ''}
                                </span>
                                <span class="urdu-font-bold ${player.id === winner.id ? 'text-green-600' : player.id === loser.id ? 'text-red-600' : 'text-slate-700'}">${formatScore(player.score)}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-xs text-slate-500 urdu-font-normal text-center mb-3">
                        ${record.history.length} راؤنڈز • ${record.userId === userId ? 'آپ کی گیم' : 'دیگر کھلاڑی'}
                    </div>
                    <div class="flex justify-center">
                        <button class="view-details-btn px-4 py-2 bg-cyan-600 text-white urdu-font-normal rounded-lg hover:bg-cyan-700 transition-colors text-sm flex items-center gap-1">
                            مکمل تفصیل دیکھیں
                        </button>
                    </div>
                `;
                
                const viewDetailsBtn = recordEl.querySelector('.view-details-btn');
                viewDetailsBtn.addEventListener('click', () => {
                    showRecordDetails(record);
                });
                
                ui.recordsList.appendChild(recordEl);
            });
        };

        const showRecordDetails = (record) => {
            ui.recordDetailsContent.innerHTML = '';
            
            const date = new Date(record.timestamp);
            const dateString = date.toLocaleDateString('ur-PK', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const winner = record.players.reduce((min, player) => 
                player.score < min.score ? player : min, record.players[0]);
            const loser = record.players.reduce((max, player) => 
                player.score > max.score ? player : max, record.players[0]);
            
            const headerSection = document.createElement('div');
            headerSection.className = 'mb-6 p-4 bg-slate-50 rounded-lg';
            headerSection.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-sm text-slate-600 urdu-font-normal">تاریخ</p>
                        <p class="text-lg urdu-font-bold">${dateString}</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-600 urdu-font-normal">گیم کی حد</p>
                        <p class="text-lg urdu-font-bold">${formatScore(record.gameLimit)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-slate-600 urdu-font-normal">کل راؤنڈز</p>
                        <p class="text-lg urdu-font-bold">${record.history.length}</p>
                    </div>
                </div>
            `;
            ui.recordDetailsContent.appendChild(headerSection);
            
            const resultsSection = document.createElement('div');
            resultsSection.className = 'mb-6';
            resultsSection.innerHTML = `
                <h3 class="text-xl urdu-font-bold mb-4 text-center">حتمی نتائج</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${record.players.map(player => `
                        <div class="p-4 border rounded-lg ${player.id === winner.id ? 'bg-green-50 border-green-200' : player.id === loser.id ? 'bg-red-50 border-red-200' : 'bg-white border-slate-200'}">
                            <div class="flex justify-between items-center">
                                <span class="urdu-font-bold ${player.id === winner.id ? 'text-green-700' : player.id === loser.id ? 'text-red-700' : 'text-slate-700'}">
                                    ${player.name}
                                    ${player.id === winner.id ? ' 👑' : player.id === loser.id ? ' 💀' : ''}
                                </span>
                                <span class="text-lg urdu-font-bold ${player.id === winner.id ? 'text-green-600' : player.id === loser.id ? 'text-red-600' : 'text-slate-600'}">
                                    ${formatScore(player.score)}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            ui.recordDetailsContent.appendChild(resultsSection);
            
            ui.recordDetailsModal.classList.remove('hidden');
        };

        // --- INITIALIZATION ---

        const init = async () => {
            initializeEventListeners();
            
            // 1. Initialize Firebase
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug'); // Uncomment for debugging
                
                // 2. Authenticate
                ui.authStatus.textContent = 'تصدیق کی جا رہی ہے...';
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || 'anonymous';
                ui.userIdDisplay.textContent = userId;
                ui.authStatus.textContent = `تصدیق ہو گئی! (${auth.currentUser?.isAnonymous ? 'مہمان' : 'یوزر'})`;
                
                // 3. Set up snapshot listener for game state (handles initial load and future changes)
                await setupGameStateListener();
                
                // 4. Initial load of records
                await fetchAndRenderRecords(false);

            } catch (error) {
                console.error("Firebase Init Error:", error);
                ui.authStatus.textContent = 'Firebase میں خرابی! ڈیٹا محفوظ نہیں ہو گا.';
                
                // If Firebase fails, show UI with default state after a delay
                renderGameUI();
                setTimeout(() => {
                    ui.loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => ui.loadingOverlay.classList.add('hidden'), 500);
                }, 1000);
            }
        };

        // Start the application
        init();
    </script>
</body>
</html>

